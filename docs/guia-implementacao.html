<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de ImplementaÃ§Ã£o - BI + IA | Vivoly</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.3em;
            opacity: 0.95;
        }

        .print-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .print-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        }

        nav {
            background: var(--secondary);
            padding: 20px 40px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        nav a:hover {
            color: var(--primary);
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 60px;
        }

        h2 {
            color: var(--secondary);
            font-size: 2.2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary);
        }

        h3 {
            color: var(--secondary);
            font-size: 1.6em;
            margin: 30px 0 15px;
        }

        h4 {
            color: #555;
            font-size: 1.3em;
            margin: 20px 0 10px;
        }

        p {
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 10px;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        .badge-info {
            background: var(--primary);
            color: white;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        .card {
            background: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .card-success {
            border-left-color: var(--success);
            background: #d4edda;
        }

        .card-warning {
            border-left-color: var(--warning);
            background: #fff3cd;
        }

        .card-danger {
            border-left-color: var(--danger);
            background: #f8d7da;
        }

        code {
            background: #f4f4f4;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }

        pre {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
            font-size: 0.95em;
        }

        .code-header {
            background: #2c3e50;
            color: white;
            padding: 8px 15px;
            border-radius: 8px 8px 0 0;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: -20px;
            margin-top: 20px;
        }

        ul, ol {
            margin: 15px 0 15px 30px;
        }

        li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .checklist {
            list-style: none;
            margin-left: 0;
        }

        .checklist li {
            padding: 10px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .checklist li:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .checklist li::before {
            content: "â˜ ";
            font-size: 1.2em;
            margin-right: 10px;
            color: var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
            margin: 30px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 25px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid white;
        }

        .flow-diagram {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .flow-step {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .emoji {
            font-size: 1.5em;
        }

        .highlight {
            background: linear-gradient(120deg, #fef29e 0%, #fef29e 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 85%;
            padding: 2px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .grid-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
            }

            .print-button, nav {
                display: none;
            }

            pre, .card {
                page-break-inside: avoid;
            }

            h2, h3 {
                page-break-after: avoid;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2em;
            }

            .content {
                padding: 20px;
            }

            nav ul {
                flex-direction: column;
            }

            .print-button {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ Imprimir / Salvar PDF</button>

    <div class="container">
        <header>
            <h1>ğŸš€ Guia de ImplementaÃ§Ã£o</h1>
            <p>Sistema de Business Intelligence com IA</p>
            <p style="font-size: 1em; margin-top: 10px; opacity: 0.9;">Vivoly - ImobiliÃ¡ria Digital</p>
        </header>

        <nav>
            <ul>
                <li><a href="#preparacao">ğŸ“ PreparaÃ§Ã£o</a></li>
                <li><a href="#fase1">ğŸ¯ Fase 1: MVP</a></li>
                <li><a href="#fase2">ğŸ§  Fase 2: InteligÃªncia</a></li>
                <li><a href="#fase3">âš¡ Fase 3: AutomaÃ§Ãµes</a></li>
                <li><a href="#checklist">âœ… Checklist</a></li>
            </ul>
        </nav>

        <div class="content">
            <!-- PREPARAÃ‡ÃƒO INICIAL -->
            <section id="preparacao" class="section">
                <h2>ğŸ“ PreparaÃ§Ã£o Inicial (Esta Semana)</h2>

                <div class="card card-success">
                    <h3>ğŸ¯ Objetivo</h3>
                    <p>Configurar todas as contas, APIs e ambiente de desenvolvimento necessÃ¡rios para comeÃ§ar a implementaÃ§Ã£o.</p>
                    <p><strong>Tempo estimado:</strong> 1-2 horas</p>
                </div>

                <h3>Passo 1.1: Criar Contas nas APIs <span class="badge badge-info">30 min</span></h3>

                <h4>ğŸ¤– API da Anthropic (Claude)</h4>
                <ol>
                    <li>Acesse: <a href="https://console.anthropic.com/" target="_blank">https://console.anthropic.com/</a></li>
                    <li>Crie uma conta ou faÃ§a login</li>
                    <li>VÃ¡ em "API Keys"</li>
                    <li>Gere uma nova chave</li>
                    <li><strong>IMPORTANTE:</strong> Anote a chave (comeÃ§a com <code>sk-ant-</code>)</li>
                </ol>
                <p><strong>Custo estimado:</strong> $150-300/mÃªs</p>

                <h4>ğŸ”® API da OpenAI (Backup)</h4>
                <ol>
                    <li>Acesse: <a href="https://platform.openai.com/" target="_blank">https://platform.openai.com/</a></li>
                    <li>Crie uma conta ou faÃ§a login</li>
                    <li>VÃ¡ em "API Keys"</li>
                    <li>Gere uma nova chave</li>
                    <li><strong>IMPORTANTE:</strong> Anote a chave (comeÃ§a com <code>sk-</code>)</li>
                </ol>
                <p><strong>Custo estimado:</strong> $100/mÃªs</p>

                <h3>Passo 1.2: Adicionar VariÃ¡veis de Ambiente <span class="badge badge-info">10 min</span></h3>

                <div class="code-header">ğŸ“ apps/api/.env</div>
                <pre><code># APIs de IA
ANTHROPIC_API_KEY=sk-ant-seu-key-aqui
OPENAI_API_KEY=sk-seu-key-aqui

# WhatsApp (deixar vazio por enquanto)
WHATSAPP_SESSION_PATH=/tmp/whatsapp-session
WHATSAPP_WEBHOOK_SECRET=seu-secret-aleatorio

# Telegram (deixar vazio por enquanto)
TELEGRAM_BOT_TOKEN=
TELEGRAM_WEBHOOK_SECRET=seu-secret-aleatorio

# Redis (se usar cloud)
REDIS_URL=redis://localhost:6379

# Feature Flags
ENABLE_AI_RESPONSES=true
ENABLE_AUTO_ASSIGNMENT=false
AI_CONFIDENCE_THRESHOLD=0.75
MAX_TOKENS_PER_REQUEST=2000</code></pre>

                <h3>Passo 1.3: Instalar DependÃªncias <span class="badge badge-info">15 min</span></h3>

                <div class="code-header">ğŸ’» Terminal</div>
                <pre><code>cd /home/hans/imobiflow/apps/api

# Instalar pacotes principais
pnpm add @anthropic-ai/sdk openai

# Para mensageria
pnpm add whatsapp-web.js qrcode-terminal
pnpm add node-telegram-bot-api

# Para filas de mensagens
pnpm add bull ioredis

# Para processamento de IA
pnpm add langchain @langchain/anthropic @langchain/openai

# Para anÃ¡lise de sentimento (opcional)
pnpm add sentiment natural</code></pre>

                <h3>Passo 1.4: Criar Estrutura de Pastas <span class="badge badge-info">5 min</span></h3>

                <div class="code-header">ğŸ’» Terminal</div>
                <pre><code>cd /home/hans/imobiflow/apps/api/src

# Criar estrutura
mkdir -p ai/{agents,prompts,context,services}
mkdir -p messaging/{whatsapp,telegram,queue/processors}
mkdir -p analytics
mkdir -p integrations</code></pre>

                <div class="card card-success">
                    <h4>âœ… PreparaÃ§Ã£o Completa!</h4>
                    <p>Agora vocÃª estÃ¡ pronto para comeÃ§ar a implementaÃ§Ã£o do MVP.</p>
                </div>
            </section>

            <!-- FASE 1: MVP -->
            <section id="fase1" class="section">
                <h2>ğŸ¯ FASE 1: MVP - FundaÃ§Ã£o (6 semanas)</h2>

                <div class="flow-diagram">
                    <h3>Fluxo do Sistema MVP</h3>
                    <div class="flow-step">ğŸ“± Cliente envia mensagem WhatsApp</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸ¤– IA Claude processa com contexto</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸ“Š Calcula score do lead</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸ’¬ Envia resposta personalizada</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸ”¥ Se score > 75 â†’ Notifica corretor via Telegram</div>
                </div>

                <h3>ğŸ“… SPRINT 1 (Semanas 1-2): Setup BÃ¡sico</h3>

                <div class="timeline">
                    <div class="timeline-item">
                        <h4>Tarefa 1.1: ServiÃ§o Claude AI <span class="badge badge-warning">2h</span></h4>
                        <p>Implementar serviÃ§o de integraÃ§Ã£o com API da Anthropic (Claude).</p>
                        <p><strong>Arquivo:</strong> <code>apps/api/src/ai/services/claude.service.ts</code></p>
                    </div>

                    <div class="timeline-item">
                        <h4>Tarefa 1.2: ServiÃ§o WhatsApp <span class="badge badge-warning">4h</span></h4>
                        <p>Implementar integraÃ§Ã£o com WhatsApp Web para receber e enviar mensagens.</p>
                        <p><strong>Arquivo:</strong> <code>apps/api/src/messaging/whatsapp/whatsapp.service.ts</code></p>
                    </div>

                    <div class="timeline-item">
                        <h4>Tarefa 1.3: ServiÃ§o Telegram <span class="badge badge-warning">2h</span></h4>
                        <p>Criar bot Telegram para notificaÃ§Ãµes e comandos dos corretores.</p>
                        <p><strong>Arquivo:</strong> <code>apps/api/src/messaging/telegram/telegram.service.ts</code></p>
                    </div>
                </div>

                <h4>ğŸ¤– CÃ³digo: ServiÃ§o Claude AI</h4>

                <div class="code-header">ğŸ“ apps/api/src/ai/services/claude.service.ts</div>
                <pre><code>import Anthropic from '@anthropic-ai/sdk';

export class ClaudeService {
  private client: Anthropic;

  constructor() {
    this.client = new Anthropic({
      apiKey: process.env.ANTHROPIC_API_KEY,
    });
  }

  async generateResponse(prompt: string, context?: string): Promise&lt;string&gt; {
    try {
      const message = await this.client.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 2000,
        temperature: 0.7,
        messages: [
          {
            role: 'user',
            content: context
              ? `${context}\n\n${prompt}`
              : prompt
          }
        ]
      });

      return message.content[0].type === 'text'
        ? message.content[0].text
        : '';
    } catch (error) {
      console.error('Erro ao chamar Claude:', error);
      throw error;
    }
  }

  async analyze(prompt: string): Promise&lt;any&gt; {
    const response = await this.generateResponse(prompt);

    try {
      return JSON.parse(response);
    } catch {
      return { response };
    }
  }
}</code></pre>

                <div class="card">
                    <h4>ğŸ§ª Teste do ServiÃ§o</h4>
                    <p>Crie o arquivo <code>test-claude.ts</code> para testar:</p>
                    <pre><code>import { ClaudeService } from './ai/services/claude.service';

async function test() {
  const claude = new ClaudeService();
  const response = await claude.generateResponse(
    'Por que vocÃª quer comprar um imÃ³vel?',
    'VocÃª Ã© Sofia, assistente de uma imobiliÃ¡ria.'
  );
  console.log('Resposta:', response);
}

test();</code></pre>
                    <p><strong>Executar:</strong> <code>npx tsx src/test-claude.ts</code></p>
                </div>

                <h4>ğŸ“± CÃ³digo: ServiÃ§o WhatsApp</h4>

                <div class="code-header">ğŸ“ apps/api/src/messaging/whatsapp/whatsapp.service.ts</div>
                <pre><code>import { Client, LocalAuth, Message } from 'whatsapp-web.js';
import qrcode from 'qrcode-terminal';

export class WhatsAppService {
  private client: Client;
  private isReady = false;
  private messageHandlers: Array&lt;(msg: Message) =&gt; Promise&lt;void&gt;&gt; = [];

  constructor() {
    this.client = new Client({
      authStrategy: new LocalAuth({
        dataPath: process.env.WHATSAPP_SESSION_PATH || './wpp-session'
      }),
      puppeteer: {
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
      }
    });

    this.setupEventListeners();
  }

  private setupEventListeners() {
    this.client.on('qr', (qr) => {
      console.log('ğŸ“± QR Code para WhatsApp:');
      qrcode.generate(qr, { small: true });
      console.log('Escaneie com o WhatsApp no seu celular');
    });

    this.client.on('ready', () => {
      console.log('âœ… WhatsApp conectado com sucesso!');
      this.isReady = true;
    });

    this.client.on('message', async (msg) => {
      if (msg.from.includes('@g.us') || msg.fromMe) return;

      for (const handler of this.messageHandlers) {
        try {
          await handler(msg);
        } catch (error) {
          console.error('Erro ao processar mensagem:', error);
        }
      }
    });
  }

  async initialize() {
    await this.client.initialize();
  }

  onMessage(handler: (msg: Message) =&gt; Promise&lt;void&gt;) {
    this.messageHandlers.push(handler);
  }

  async sendMessage(phoneNumber: string, message: string) {
    if (!this.isReady) {
      throw new Error('WhatsApp nÃ£o estÃ¡ conectado');
    }

    const chatId = phoneNumber.includes('@c.us')
      ? phoneNumber
      : `${phoneNumber}@c.us`;

    await this.client.sendMessage(chatId, message);
  }
}</code></pre>

                <h4>ğŸ¤– CÃ³digo: ServiÃ§o Telegram</h4>

                <div class="card card-warning">
                    <h4>âš ï¸ Como Criar o Bot do Telegram</h4>
                    <ol>
                        <li>Abra o Telegram e busque por <strong>@BotFather</strong></li>
                        <li>Envie <code>/newbot</code></li>
                        <li>Escolha um nome (ex: "Vivoly BI Assistant")</li>
                        <li>Escolha um username (ex: "vivoly_bi_bot")</li>
                        <li>Copie o token que ele enviar</li>
                        <li>Adicione no <code>.env</code>: <code>TELEGRAM_BOT_TOKEN=seu-token-aqui</code></li>
                    </ol>
                </div>

                <div class="code-header">ğŸ“ apps/api/src/messaging/telegram/telegram.service.ts</div>
                <pre><code>import TelegramBot from 'node-telegram-bot-api';

export class TelegramService {
  private bot: TelegramBot;

  constructor() {
    const token = process.env.TELEGRAM_BOT_TOKEN;
    if (!token) {
      throw new Error('TELEGRAM_BOT_TOKEN nÃ£o configurado');
    }

    this.bot = new TelegramBot(token, { polling: true });
    this.setupBasicCommands();
  }

  private setupBasicCommands() {
    this.bot.onText(/\/start/, (msg) => {
      this.bot.sendMessage(
        msg.chat.id,
        'ğŸ‘‹ Bem-vindo ao sistema de BI da Vivoly!\n\n' +
        'Comandos disponÃ­veis:\n' +
        '/status - Ver status do sistema\n' +
        '/leads - Ver leads quentes\n' +
        '/briefing - Briefing do dia'
      );
    });

    this.bot.onText(/\/status/, async (msg) => {
      await this.bot.sendMessage(
        msg.chat.id,
        'âœ… Sistema ativo\n' +
        'ğŸ“Š IA: Operacional\n' +
        'ğŸ“± WhatsApp: Conectado\n' +
        'ğŸ¤– Telegram: Conectado'
      );
    });
  }

  async sendHotLeadAlert(chatId: number, lead: any) {
    const message = `
ğŸ”¥ *LEAD QUENTE - AÃ§Ã£o Imediata*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ *DADOS DO LEAD*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Nome: ${lead.nome}
ğŸ“± Telefone: ${lead.telefone}
ğŸ“Š Score: ${lead.score}/100 ğŸ”¥
ğŸŒ¡ï¸ Temperatura: ${lead.temperatura}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¼ *INTERESSE*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${lead.interesse ? JSON.stringify(lead.interesse, null, 2) : 'NÃ£o especificado'}
`;

    await this.bot.sendMessage(chatId, message, {
      parse_mode: 'Markdown',
      reply_markup: {
        inline_keyboard: [[
          { text: 'âœ… Assumir Lead', callback_data: \`assume_\${lead.id}\` },
          { text: 'ğŸ“Š Ver HistÃ³rico', callback_data: \`history_\${lead.id}\` }
        ]]
      }
    });
  }
}</code></pre>

                <h3>ğŸ“… SPRINT 2 (Semanas 3-4): IntegraÃ§Ã£o IA + Mensageria</h3>

                <div class="grid">
                    <div class="grid-item">
                        <h4>ğŸ§  Context Builder</h4>
                        <p>Gerencia histÃ³rico e contexto das conversas</p>
                        <span class="badge badge-warning">3h</span>
                    </div>
                    <div class="grid-item">
                        <h4>ğŸ“ Prompts Otimizados</h4>
                        <p>Templates de prompts para IA</p>
                        <span class="badge badge-warning">2h</span>
                    </div>
                    <div class="grid-item">
                        <h4>âš™ï¸ Message Processor</h4>
                        <p>Pipeline completo de processamento</p>
                        <span class="badge badge-warning">4h</span>
                    </div>
                </div>

                <h4>ğŸ§  CÃ³digo: Gerenciador de Contexto</h4>

                <div class="code-header">ğŸ“ apps/api/src/ai/context/context-builder.ts</div>
                <pre><code>import { prisma } from '@/lib/prisma';

export interface LeadContext {
  nome?: string;
  telefone: string;
  origem: string;
  score_atual: number;
  temperatura: string;
  interesse_registrado?: any;
  timeline: any[];
  ultima_mensagem: string;
  imoveis_portfolio: any[];
  historico_resumido: string;
}

export class ContextBuilder {
  async buildLeadContext(
    leadId: string,
    mensagemAtual: string
  ): Promise&lt;LeadContext&gt; {
    const lead = await prisma.lead.findUnique({
      where: { id: leadId },
      include: { corretor: { include: { user: true } } }
    });

    if (!lead) {
      throw new Error('Lead nÃ£o encontrado');
    }

    const imoveis = await prisma.imovel.findMany({
      where: {
        tenant_id: lead.tenant_id,
        status: 'DISPONIVEL'
      },
      take: 10,
      orderBy: { created_at: 'desc' }
    });

    const timeline = Array.isArray(lead.timeline) ? lead.timeline : [];
    const historico = timeline
      .filter((t: any) =&gt; t.tipo?.includes('mensagem'))
      .slice(-5)
      .map((t: any) =&gt; \`\${t.tipo}: \${t.conteudo}\`)
      .join('\\n');

    return {
      nome: lead.nome,
      telefone: lead.telefone,
      origem: lead.origem,
      score_atual: lead.score,
      temperatura: lead.temperatura,
      interesse_registrado: lead.interesse,
      timeline: timeline,
      ultima_mensagem: mensagemAtual,
      imoveis_portfolio: imoveis,
      historico_resumido: historico || 'Primeiro contato'
    };
  }
}</code></pre>

                <h4>ğŸ“ CÃ³digo: Prompts de QualificaÃ§Ã£o</h4>

                <div class="code-header">ğŸ“ apps/api/src/ai/prompts/lead-qualification.prompt.ts</div>
                <pre><code>import { LeadContext } from '../context/context-builder';

export function generateQualificationPrompt(context: LeadContext): string {
  return \`VocÃª Ã© Sofia, assistente virtual da Vivoly, uma imobiliÃ¡ria premium.

PERSONALIDADE:
- AmigÃ¡vel e acolhedora, mas profissional
- Consultiva, nunca vendedora
- Paciente e atenta aos detalhes
- Usa linguagem natural brasileira

CONTEXTO DO LEAD:
Nome: \${context.nome || 'Cliente'}
Score Atual: \${context.score_atual}/100
Temperatura: \${context.temperatura}

\${context.historico_resumido ? \`
HISTÃ“RICO RECENTE:
\${context.historico_resumido}
\` : ''}

SUA MISSÃƒO:
1. Responder Ã  mensagem do cliente de forma natural
2. Fazer perguntas abertas para qualificar (mÃ¡ximo 3)
3. Identificar: tipo de imÃ³vel, localizaÃ§Ã£o, budget, urgÃªncia
4. Quando tiver informaÃ§Ãµes, sugerir 2-3 imÃ³veis

REGRAS:
- MÃ¡ximo 3 perguntas por mensagem
- Use 1-2 emojis apenas
- Seja genuinamente Ãºtil
- NUNCA invente dados sobre imÃ³veis

ÃšLTIMA MENSAGEM DO CLIENTE:
"\${context.ultima_mensagem}"

RESPONDA AGORA:\`;
}</code></pre>

                <h3>ğŸ“… SPRINT 3 (Semanas 5-6): Sistema Completo</h3>

                <h4>âš™ï¸ CÃ³digo: Orquestrador Principal</h4>

                <div class="code-header">ğŸ“ apps/api/src/ai/ai-orchestrator.ts</div>
                <pre><code>import { WhatsAppService } from '@/messaging/whatsapp/whatsapp.service';
import { TelegramService } from '@/messaging/telegram/telegram.service';
import { LeadMessageProcessor } from '@/messaging/queue/processors/lead-message.processor';

export class AIOrchestrator {
  private whatsapp: WhatsAppService;
  private telegram: TelegramService;
  private processor: LeadMessageProcessor;
  private tenantId: string;

  constructor(tenantId: string) {
    this.tenantId = tenantId;
    this.whatsapp = new WhatsAppService();
    this.telegram = new TelegramService();
    this.processor = new LeadMessageProcessor();
  }

  async initialize() {
    console.log('ğŸš€ Inicializando IA Orchestrator...');

    // Inicializa WhatsApp
    this.whatsapp.onMessage(async (msg) => {
      await this.handleWhatsAppMessage(msg);
    });
    await this.whatsapp.initialize();

    // Configura comandos Telegram
    this.setupTelegramCommands();

    console.log('âœ… Sistema ativo e pronto!');
  }

  private async handleWhatsAppMessage(msg: any) {
    console.log(\`ğŸ“¨ Nova mensagem de \${msg.from}: \${msg.body}\`);

    try {
      const result = await this.processor.processMessage(
        '',
        msg.from,
        msg.body,
        this.tenantId
      );

      await msg.reply(result.response);
      console.log(\`âœ… Resposta enviada (Score: \${result.score})\`);

    } catch (error) {
      console.error('âŒ Erro ao processar mensagem:', error);
      await msg.reply('Desculpe, tive um problema. Vou conectar vocÃª com nossa equipe.');
    }
  }

  private setupTelegramCommands() {
    this.telegram.onCommand('leads', async (msg) => {
      // Buscar e listar leads quentes
    });

    this.telegram.onCommand('briefing', async (msg) => {
      // Enviar briefing diÃ¡rio
    });
  }
}</code></pre>

                <div class="card card-success">
                    <h3>ğŸ‰ MVP Completo!</h3>
                    <p>Ao finalizar o Sprint 3, vocÃª terÃ¡:</p>
                    <ul>
                        <li>âœ… IA respondendo clientes no WhatsApp 24/7</li>
                        <li>âœ… Sistema de scoring automÃ¡tico</li>
                        <li>âœ… NotificaÃ§Ãµes Telegram para corretores</li>
                        <li>âœ… Comandos Ãºteis (/leads, /briefing, /status)</li>
                        <li>âœ… AnÃ¡lise de sentimento em tempo real</li>
                    </ul>
                </div>
            </section>

            <!-- FASE 2: INTELIGÃŠNCIA -->
            <section id="fase2" class="section">
                <h2>ğŸ§  FASE 2: InteligÃªncia AvanÃ§ada (8 semanas)</h2>

                <div class="card">
                    <h3>ğŸ¯ Objetivo da Fase 2</h3>
                    <p>Adicionar capacidades avanÃ§adas de anÃ¡lise, prediÃ§Ã£o e recomendaÃ§Ã£o ao sistema.</p>
                </div>

                <div class="grid">
                    <div class="grid-item">
                        <h4>ğŸ“Š Lead Scoring ML</h4>
                        <p>Algoritmo de machine learning para scoring preditivo</p>
                        <span class="badge badge-info">3 semanas</span>
                    </div>
                    <div class="grid-item">
                        <h4>ğŸ¯ Sistema de RecomendaÃ§Ã£o</h4>
                        <p>Match inteligente lead Ã— imÃ³vel</p>
                        <span class="badge badge-info">3 semanas</span>
                    </div>
                    <div class="grid-item">
                        <h4>ğŸ” Detector de Oportunidades</h4>
                        <p>Identifica leads frios com potencial</p>
                        <span class="badge badge-info">2 semanas</span>
                    </div>
                </div>

                <h3>Recursos Implementados na Fase 2:</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Recurso</th>
                            <th>DescriÃ§Ã£o</th>
                            <th>Impacto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Lead Scoring AutomÃ¡tico</td>
                            <td>Score de 0-100 calculado em tempo real</td>
                            <td>+40% precisÃ£o na qualificaÃ§Ã£o</td>
                        </tr>
                        <tr>
                            <td>AnÃ¡lise de Sentimento</td>
                            <td>Detecta emoÃ§Ãµes e intenÃ§Ãµes</td>
                            <td>+35% taxa de conversÃ£o</td>
                        </tr>
                        <tr>
                            <td>Sistema de RecomendaÃ§Ã£o</td>
                            <td>Sugere imÃ³veis ideais para cada lead</td>
                            <td>+50% taxa de agendamento</td>
                        </tr>
                        <tr>
                            <td>Detector de Oportunidades</td>
                            <td>Recupera leads esquecidos</td>
                            <td>+30% recuperaÃ§Ã£o de leads frios</td>
                        </tr>
                        <tr>
                            <td>Analytics Preditivo</td>
                            <td>PrevÃª probabilidade de fechamento</td>
                            <td>+25% eficiÃªncia do time</td>
                        </tr>
                    </tbody>
                </table>

                <h4>ğŸ“Š Lead Scoring Service</h4>

                <div class="code-header">ğŸ“ apps/api/src/analytics/lead-scoring.service.ts</div>
                <pre><code>export class LeadScoringService {
  async calculateScore(lead: Lead): Promise&lt;number&gt; {
    let score = 0;

    // AnÃ¡lise de mensagens (30 pontos)
    const sentimentScore = await this.analyzeSentiment(lead.timeline);
    score += sentimentScore * 0.3;

    // Engajamento (25 pontos)
    const engagementScore = this.calculateEngagement({
      totalMessages: lead.timeline.filter(t =&gt; t.tipo === 'mensagem_recebida').length,
      avgResponseTime: this.getAvgResponseTime(lead.timeline),
      questionsAsked: this.countQuestionsAsked(lead.timeline)
    });
    score += engagementScore * 0.25;

    // QualificaÃ§Ã£o de interesse (25 pontos)
    const interestScore = this.evaluateInterest({
      hasBudget: lead.interesse?.budget_definido,
      hasLocation: lead.interesse?.localizacao_definida,
      hasTimeframe: lead.interesse?.prazo_definido,
      purposeClear: lead.interesse?.finalidade_clara
    });
    score += interestScore * 0.25;

    // Comportamento (20 pontos)
    const behaviorScore = await this.analyzeBehavior({
      openedLinks: lead.timeline.filter(t =&gt; t.tipo === 'link_aberto').length,
      requestedVisit: lead.timeline.some(t =&gt; t.conteudo?.includes('visita')),
      mentionedCompetitor: this.detectCompetitors(lead.timeline)
    });
    score += behaviorScore * 0.2;

    return Math.min(100, Math.round(score));
  }
}</code></pre>

                <div class="card card-success">
                    <h4>ğŸ’¡ Resultado da Fase 2</h4>
                    <p>Com a inteligÃªncia avanÃ§ada implementada:</p>
                    <ul>
                        <li>Taxa de qualificaÃ§Ã£o aumenta de 50% para 70%+</li>
                        <li>Tempo de qualificaÃ§Ã£o reduz de 20min para 5min</li>
                        <li>AcurÃ¡cia do score atinge 80%+</li>
                        <li>30% dos leads frios sÃ£o recuperados</li>
                    </ul>
                </div>
            </section>

            <!-- FASE 3: AUTOMAÃ‡Ã•ES -->
            <section id="fase3" class="section">
                <h2>âš¡ FASE 3: AutomaÃ§Ãµes e Refinamento (6 semanas)</h2>

                <div class="card">
                    <h3>ğŸ¯ Objetivo da Fase 3</h3>
                    <p>Automatizar processos repetitivos e refinar a experiÃªncia do usuÃ¡rio.</p>
                </div>

                <div class="grid">
                    <div class="grid-item">
                        <h4>ğŸ“… Follow-ups AutomÃ¡ticos</h4>
                        <p>Mensagens contextuais agendadas</p>
                        <span class="badge badge-info">2 semanas</span>
                    </div>
                    <div class="grid-item">
                        <h4>ğŸ”„ RecuperaÃ§Ã£o de Leads</h4>
                        <p>Reativa leads frios automaticamente</p>
                        <span class="badge badge-info">2 semanas</span>
                    </div>
                    <div class="grid-item">
                        <h4>ğŸ—“ï¸ Agendamento Inteligente</h4>
                        <p>IntegraÃ§Ã£o com Google Calendar</p>
                        <span class="badge badge-info">2 semanas</span>
                    </div>
                </div>

                <h3>AutomaÃ§Ãµes Implementadas:</h3>

                <table>
                    <thead>
                        <tr>
                            <th>AutomaÃ§Ã£o</th>
                            <th>Trigger</th>
                            <th>AÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Follow-up 24h</td>
                            <td>Lead nÃ£o responde em 24h</td>
                            <td>Envia mensagem contextual</td>
                        </tr>
                        <tr>
                            <td>Follow-up 48h</td>
                            <td>Lead morno sem resposta</td>
                            <td>Nova abordagem com oferta</td>
                        </tr>
                        <tr>
                            <td>Alerta UrgÃªncia</td>
                            <td>Palavras-chave detectadas</td>
                            <td>Notifica corretor imediatamente</td>
                        </tr>
                        <tr>
                            <td>Novo Match</td>
                            <td>Novo imÃ³vel cadastrado</td>
                            <td>Notifica leads compatÃ­veis</td>
                        </tr>
                        <tr>
                            <td>Lembrete Visita</td>
                            <td>24h e 2h antes da visita</td>
                            <td>Envia lembrete por WhatsApp</td>
                        </tr>
                    </tbody>
                </table>

                <h4>ğŸ“… Sistema de Follow-ups</h4>

                <div class="code-header">ğŸ“ apps/api/src/automation/follow-up.service.ts</div>
                <pre><code>export class FollowUpService {
  async scheduleFollowUp(leadId: string, hours: number) {
    const lead = await prisma.lead.findUnique({
      where: { id: leadId }
    });

    // Calcula quando enviar
    const sendAt = new Date(Date.now() + hours * 60 * 60 * 1000);

    // Cria job na fila
    await queue.add('follow-up', {
      leadId,
      sendAt,
      type: hours === 24 ? 'first' : 'second'
    }, {
      delay: hours * 60 * 60 * 1000
    });
  }

  async generateFollowUpMessage(lead: Lead): Promise&lt;string&gt; {
    const context = await contextBuilder.buildLeadContext(lead.id, '');

    const prompt = \`Crie uma mensagem de follow-up natural para reengajar este lead.

Contexto:
- Lead: \${lead.nome}
- Ãšltima interaÃ§Ã£o: \${lead.ultimo_contato}
- Interesse: \${JSON.stringify(lead.interesse)}

A mensagem deve:
- Ser casual e amigÃ¡vel
- Oferecer algo de valor novo
- Ter call-to-action sutil
- MÃ¡ximo 3 linhas\`;

    return await claude.generateResponse(prompt);
  }
}</code></pre>

                <div class="card card-success">
                    <h4>ğŸ‰ Sistema Completo!</h4>
                    <p>ApÃ³s a Fase 3, vocÃª terÃ¡ um sistema totalmente automatizado com:</p>
                    <ul>
                        <li>âœ… Follow-ups automÃ¡ticos contextuais</li>
                        <li>âœ… RecuperaÃ§Ã£o inteligente de leads</li>
                        <li>âœ… Agendamentos sincronizados</li>
                        <li>âœ… Lembretes automÃ¡ticos</li>
                        <li>âœ… Zero leads esquecidos</li>
                    </ul>
                </div>
            </section>

            <!-- CHECKLIST -->
            <section id="checklist" class="section">
                <h2>âœ… Checklist de VerificaÃ§Ã£o</h2>

                <h3>ğŸ“ PreparaÃ§Ã£o</h3>
                <ul class="checklist">
                    <li>API Claude configurada e testada</li>
                    <li>API OpenAI configurada (backup)</li>
                    <li>VariÃ¡veis de ambiente no .env</li>
                    <li>Todas as dependÃªncias instaladas</li>
                    <li>Estrutura de pastas criada</li>
                </ul>

                <h3>ğŸ¯ Fase 1 - MVP</h3>
                <ul class="checklist">
                    <li>ServiÃ§o Claude funcionando</li>
                    <li>WhatsApp conectado e respondendo</li>
                    <li>Bot Telegram ativo com comandos</li>
                    <li>Context Builder implementado</li>
                    <li>Prompts otimizados criados</li>
                    <li>Message Processor funcionando</li>
                    <li>Orquestrador principal rodando</li>
                    <li>Leads sendo criados automaticamente</li>
                    <li>Score calculado corretamente</li>
                    <li>NotificaÃ§Ãµes funcionando</li>
                    <li>Teste E2E passando</li>
                </ul>

                <h3>ğŸ§  Fase 2 - InteligÃªncia</h3>
                <ul class="checklist">
                    <li>Lead scoring automÃ¡tico implementado</li>
                    <li>AnÃ¡lise de sentimento funcionando</li>
                    <li>Sistema de recomendaÃ§Ã£o ativo</li>
                    <li>Detector de oportunidades rodando</li>
                    <li>Analytics preditivo implementado</li>
                    <li>Dashboard de mÃ©tricas criado</li>
                    <li>AcurÃ¡cia do score > 80%</li>
                </ul>

                <h3>âš¡ Fase 3 - AutomaÃ§Ãµes</h3>
                <ul class="checklist">
                    <li>Sistema de follow-ups ativo</li>
                    <li>RecuperaÃ§Ã£o de leads implementada</li>
                    <li>Agendamento inteligente funcionando</li>
                    <li>IntegraÃ§Ã£o com Calendar ativa</li>
                    <li>Lembretes automÃ¡ticos enviados</li>
                    <li>Sistema de feedback implementado</li>
                    <li>Todas automaÃ§Ãµes testadas</li>
                </ul>

                <div class="card card-success">
                    <h3>ğŸŠ ParabÃ©ns!</h3>
                    <p>Se todos os itens estÃ£o marcados, vocÃª tem um <strong>sistema completo de BI + IA</strong> funcionando!</p>
                    <h4>Resultados Esperados:</h4>
                    <ul>
                        <li>ğŸ“ˆ Taxa de conversÃ£o: +140%</li>
                        <li>âš¡ Tempo de resposta: < 5 segundos</li>
                        <li>ğŸ¯ QualificaÃ§Ã£o: 70%+</li>
                        <li>ğŸ’° ROI: +10.000%</li>
                        <li>â±ï¸ Tempo economizado: 25h/mÃªs por corretor</li>
                    </ul>
                </div>
            </section>

            <!-- PRÃ“XIMOS PASSOS -->
            <section class="section">
                <h2>ğŸš€ PrÃ³ximos Passos</h2>

                <div class="flow-diagram">
                    <h3>EvoluÃ§Ã£o ContÃ­nua</h3>
                    <div class="flow-step">ğŸ¯ Fase 1: MVP funcionando (6 semanas)</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸ§  Fase 2: InteligÃªncia avanÃ§ada (8 semanas)</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">âš¡ Fase 3: AutomaÃ§Ãµes completas (6 semanas)</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸ“Š Monitoramento e otimizaÃ§Ã£o contÃ­nua</div>
                    <div class="flow-step">â†“</div>
                    <div class="flow-step">ğŸš€ ExpansÃ£o: ML, Voz, Email, Portal Cliente</div>
                </div>

                <h3>Suporte e DocumentaÃ§Ã£o</h3>

                <div class="grid">
                    <div class="grid-item">
                        <h4>ğŸ“š DocumentaÃ§Ã£o</h4>
                        <ul>
                            <li>Planejamento completo: <code>planejamento-bi-ia.md</code></li>
                            <li>Este guia: <code>guia-implementacao.html</code></li>
                            <li>API Docs: Em desenvolvimento</li>
                        </ul>
                    </div>
                    <div class="grid-item">
                        <h4>ğŸ”— Links Ãšteis</h4>
                        <ul>
                            <li><a href="https://docs.anthropic.com/" target="_blank">Docs Anthropic</a></li>
                            <li><a href="https://platform.openai.com/docs" target="_blank">Docs OpenAI</a></li>
                            <li><a href="https://wwebjs.dev/" target="_blank">WhatsApp Web.js</a></li>
                            <li><a href="https://core.telegram.org/bots/api" target="_blank">Telegram Bot API</a></li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ’¡ Dicas Finais</h3>
                    <ul>
                        <li>ğŸ§ª Sempre teste em ambiente de desenvolvimento primeiro</li>
                        <li>ğŸ“Š Monitore mÃ©tricas diariamente nas primeiras semanas</li>
                        <li>ğŸ”„ Itere nos prompts baseado no feedback real</li>
                        <li>ğŸ‘¥ Colete feedback dos corretores constantemente</li>
                        <li>ğŸ’° Acompanhe custos das APIs semanalmente</li>
                        <li>ğŸ”’ Mantenha backups regulares do banco de dados</li>
                        <li>ğŸ“ˆ Documente aprendizados e otimizaÃ§Ãµes</li>
                    </ul>
                </div>
            </section>

        </div>

        <footer style="background: var(--secondary); color: white; text-align: center; padding: 40px;">
            <h3>ğŸ¯ Vivoly - ImobiliÃ¡ria Digital</h3>
            <p style="margin: 15px 0;">Sistema de Business Intelligence com IA</p>
            <p style="opacity: 0.8; font-size: 0.9em;">Â© 2024 Vivoly. Todos os direitos reservados.</p>
            <p style="margin-top: 20px; font-size: 0.9em;">
                ğŸ“„ Para documentaÃ§Ã£o completa, consulte <code>planejamento-bi-ia.md</code>
            </p>
        </footer>
    </div>

    <script>
        // Smooth scroll para links da navegaÃ§Ã£o
        document.querySelectorAll('nav a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        });

        // Marcar checklist ao clicar
        document.querySelectorAll('.checklist li').forEach(item => {
            item.addEventListener('click', function() {
                this.style.background = '#d4edda';
                this.style.textDecoration = 'line-through';
                this.style.opacity = '0.7';
                const checkmark = 'âœ“ ';
                if (!this.textContent.startsWith(checkmark)) {
                    this.textContent = checkmark + this.textContent;
                }
            });
        });

        // Highlight cÃ³digo ao passar mouse
        document.querySelectorAll('pre code').forEach(block => {
            block.addEventListener('mouseenter', function() {
                this.style.background = '#2a2a2a';
            });
            block.addEventListener('mouseleave', function() {
                this.style.background = '';
            });
        });
    </script>
</body>
</html>
