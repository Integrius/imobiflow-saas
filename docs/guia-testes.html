<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia Completo de Testes | Guia BI + IA</title>
    <link rel="stylesheet" href="guia-styles.css">
</head>
<body>
    <div class="container">
        <header class="phase-header phase1">
            <div class="breadcrumb">
                <a href="guia-index.html">ğŸ  Ãndice</a> â†’
                <a href="guia-fase3.html">âš¡ Fase 3</a> â†’
                <span>Testes</span>
            </div>
            <h1>ğŸ§ª Guia Completo de Testes</h1>
            <p>ValidaÃ§Ã£o e Qualidade do Sistema</p>
            <div class="phase-meta">
                <span class="badge">ğŸ“‹ Essencial</span>
                <span class="badge">âœ… Qualidade</span>
            </div>
        </header>

        <nav class="nav-sticky">
            <a href="#visao">VisÃ£o Geral</a>
            <a href="#unit">Testes UnitÃ¡rios</a>
            <a href="#integration">IntegraÃ§Ã£o</a>
            <a href="#e2e">End-to-End</a>
            <a href="#scenarios">CenÃ¡rios</a>
            <a href="#performance">Performance</a>
        </nav>

        <div class="content">
            <section id="visao">
                <h2>ğŸ“‹ VisÃ£o Geral dos Testes</h2>
                <div class="card card-info">
                    <h3>ğŸ¯ Objetivo</h3>
                    <p>Garantir que todo o sistema estÃ¡ funcionando corretamente antes do deploy em produÃ§Ã£o.</p>
                </div>

                <div class="card card-warning">
                    <h3>âš ï¸ Checklist PrÃ©-Testes</h3>
                    <ul>
                        <li>âœ… Todas as fases implementadas (1, 2 e 3)</li>
                        <li>âœ… Banco de dados configurado</li>
                        <li>âœ… VariÃ¡veis de ambiente definidas</li>
                        <li>âœ… APIs com crÃ©ditos (Anthropic, OpenAI)</li>
                        <li>âœ… WhatsApp pronto para conexÃ£o</li>
                        <li>âœ… Telegram bot configurado</li>
                    </ul>
                </div>
            </section>

            <section id="unit">
                <h2>ğŸ”¬ Testes UnitÃ¡rios</h2>

                <h3>ConfiguraÃ§Ã£o do Jest</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/jest.config.js</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/__tests__/**/*.ts', '**/?(*.)+(spec|test).ts'],
  transform: {
    '^.+\\.ts$': 'ts-jest',
  },
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.test.ts',
    '!src/**/*.spec.ts',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
};</code></pre>
                </div>

                <h3>Teste: ClaudeService</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/src/ai/services/__tests__/claude.service.test.ts</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>import { ClaudeService } from '../claude.service';

describe('ClaudeService', () => {
  let service: ClaudeService;

  beforeEach(() => {
    service = new ClaudeService();
  });

  describe('generateResponse', () => {
    it('deve gerar uma resposta vÃ¡lida', async () => {
      const response = await service.generateResponse('Diga olÃ¡');

      expect(response).toBeDefined();
      expect(typeof response).toBe('string');
      expect(response.length).toBeGreaterThan(0);
    });

    it('deve usar contexto quando fornecido', async () => {
      const context = 'VocÃª Ã© um assistente de imobiliÃ¡ria';
      const response = await service.generateResponse(
        'Como vocÃª ajuda clientes?',
        context
      );

      expect(response).toBeDefined();
      expect(response.length).toBeGreaterThan(0);
    });

    it('deve rastrear custo e uso', async () => {
      await service.generateResponse('Teste');
      const stats = service.getStats();

      expect(stats.requestCount).toBe(1);
      expect(stats.dailyCost).toBeGreaterThan(0);
    });
  });

  describe('analyze', () => {
    it('deve retornar JSON vÃ¡lido', async () => {
      const prompt = 'Retorne {"test": true}';
      const result = await service.analyze(prompt);

      expect(result).toBeDefined();
      expect(typeof result).toBe('object');
    });
  });

  describe('resetDailyStats', () => {
    it('deve resetar estatÃ­sticas', async () => {
      await service.generateResponse('Teste');
      service.resetDailyStats();

      const stats = service.getStats();
      expect(stats.requestCount).toBe(0);
      expect(stats.dailyCost).toBe(0);
    });
  });
});</code></pre>
                </div>

                <h3>Teste: MessageProcessor</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/src/ai/services/__tests__/message-processor.test.ts</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>import { MessageProcessorService } from '../message-processor.service';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

describe('MessageProcessorService', () => {
  let service: MessageProcessorService;
  let testLeadId: string;

  beforeAll(async () => {
    // Criar lead de teste
    const lead = await prisma.lead.create({
      data: {
        phone: '5511999999999',
        tenantId: 'test',
        status: 'new',
        score: 50
      }
    });
    testLeadId = lead.id;
  });

  afterAll(async () => {
    // Limpar dados de teste
    await prisma.message.deleteMany({
      where: { leadId: testLeadId }
    });
    await prisma.lead.delete({
      where: { id: testLeadId }
    });
    await prisma.$disconnect();
  });

  beforeEach(() => {
    service = new MessageProcessorService();
  });

  describe('processIncomingMessage', () => {
    it('deve processar mensagem e retornar resposta', async () => {
      const result = await service.processIncomingMessage(
        '5511999999999',
        'OlÃ¡, procuro apartamento',
        'test'
      );

      expect(result).toBeDefined();
      expect(result.reply).toBeDefined();
      expect(result.analysis).toBeDefined();
      expect(typeof result.shouldNotifyBroker).toBe('boolean');
    });

    it('deve salvar mensagem no banco', async () => {
      await service.processIncomingMessage(
        '5511999999999',
        'Teste de mensagem',
        'test'
      );

      const messages = await prisma.message.findMany({
        where: { leadId: testLeadId }
      });

      expect(messages.length).toBeGreaterThan(0);
    });

    it('deve atualizar score do lead', async () => {
      const leadBefore = await prisma.lead.findUnique({
        where: { id: testLeadId }
      });

      await service.processIncomingMessage(
        '5511999999999',
        'Preciso urgente de um apartamento!',
        'test'
      );

      const leadAfter = await prisma.lead.findUnique({
        where: { id: testLeadId }
      });

      expect(leadAfter!.score).not.toBe(leadBefore!.score);
    });
  });
});</code></pre>
                </div>

                <div class="command-box">
pnpm test
                </div>
            </section>

            <section id="integration">
                <h2>ğŸ”— Testes de IntegraÃ§Ã£o</h2>

                <h3>Teste: Fluxo Completo de Mensagem</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/src/__tests__/integration/message-flow.test.ts</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>import { AIOrchestrator } from '../../ai/ai-orchestrator.service';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

describe('Fluxo Completo de Mensagem', () => {
  let orchestrator: AIOrchestrator;

  beforeAll(async () => {
    orchestrator = new AIOrchestrator();
    // NÃ£o inicializar WhatsApp em testes
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  it('deve processar mensagem do lead atÃ© notificaÃ§Ã£o do corretor', async () => {
    // 1. Simular recebimento de mensagem
    const mockMessage = {
      from: '5511988888888',
      body: 'Quero comprar um apartamento de 3 quartos urgente!',
      fromMe: false
    };

    // 2. Processar (sem enviar WhatsApp real)
    const processor = orchestrator['processor'];
    const result = await processor.processIncomingMessage(
      mockMessage.from,
      mockMessage.body,
      'test-tenant'
    );

    // 3. VerificaÃ§Ãµes
    expect(result.reply).toBeDefined();
    expect(result.analysis.urgency).toBe('alta');
    expect(result.shouldNotifyBroker).toBe(true);

    // 4. Verificar que lead foi criado
    const lead = await prisma.lead.findFirst({
      where: { phone: mockMessage.from }
    });

    expect(lead).toBeDefined();
    expect(lead!.score).toBeGreaterThan(50);
  });
});</code></pre>
                </div>

                <h3>Teste: Lead Scoring ML</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/src/__tests__/integration/lead-scoring.test.ts</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>import { LeadScoringMLService } from '../../ai/ml/lead-scoring.service';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

describe('Lead Scoring ML', () => {
  let service: LeadScoringMLService;
  let testLeadId: string;

  beforeAll(async () => {
    service = new LeadScoringMLService();

    // Criar lead com histÃ³rico
    const lead = await prisma.lead.create({
      data: {
        phone: '5511977777777',
        tenantId: 'test',
        status: 'active',
        score: 50,
        budgetMax: 500000
      }
    });

    testLeadId = lead.id;

    // Criar mensagens de teste
    for (let i = 0; i < 15; i++) {
      await prisma.message.create({
        data: {
          leadId: testLeadId,
          content: i % 2 === 0 ? 'Pergunta do lead' : 'Resposta da IA',
          direction: i % 2 === 0 ? 'inbound' : 'outbound',
          fromNumber: i % 2 === 0 ? lead.phone : 'system',
          toNumber: i % 2 === 0 ? 'system' : lead.phone,
          tenantId: 'test',
          channel: 'whatsapp'
        }
      });
    }
  });

  afterAll(async () => {
    await prisma.message.deleteMany({ where: { leadId: testLeadId } });
    await prisma.lead.delete({ where: { id: testLeadId } });
    await prisma.$disconnect();
  });

  it('deve calcular score avanÃ§ado', async () => {
    const result = await service.calculateAdvancedScore(testLeadId);

    expect(result.score).toBeGreaterThanOrEqual(0);
    expect(result.score).toBeLessThanOrEqual(100);
    expect(result.confidence).toBeGreaterThan(0);
    expect(result.factors).toBeDefined();
    expect(result.recommendation).toBeDefined();
  });

  it('deve identificar fatores de score', async () => {
    const result = await service.calculateAdvancedScore(testLeadId);

    expect(result.factors.engagement).toBeDefined();
    expect(result.factors.urgency).toBeDefined();
    expect(result.factors.budget_clarity).toBeDefined();
  });
});</code></pre>
                </div>
            </section>

            <section id="e2e">
                <h2>ğŸ¯ Testes End-to-End</h2>

                <div class="card card-warning">
                    <h3>âš ï¸ AtenÃ§Ã£o</h3>
                    <p>Testes E2E usam serviÃ§os reais (WhatsApp, Telegram, APIs). Execute com cautela para nÃ£o consumir crÃ©ditos desnecessariamente.</p>
                </div>

                <h3>Teste E2E: Conversa Completa</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/src/__tests__/e2e/full-conversation.e2e.ts</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>import { MessageProcessorService } from '../../ai/services/message-processor.service';

describe('E2E: Conversa Completa', () => {
  let processor: MessageProcessorService;
  const testPhone = '5511966666666';
  const tenantId = 'e2e-test';

  beforeAll(() => {
    processor = new MessageProcessorService();
  });

  it('deve simular conversa realista de lead quente', async () => {
    const conversation = [
      { msg: 'Oi, procuro apartamento', expectedUrgency: 'mÃ©dia' },
      { msg: '2 quartos na zona sul', expectedUrgency: 'mÃ©dia' },
      { msg: 'AtÃ© 500 mil', expectedUrgency: 'mÃ©dia' },
      { msg: 'Preciso com urgÃªncia, mudo mÃªs que vem', expectedUrgency: 'alta' },
      { msg: 'Pode agendar visita?', expectedIntent: 'agendamento' }
    ];

    for (const turn of conversation) {
      const result = await processor.processIncomingMessage(
        testPhone,
        turn.msg,
        tenantId
      );

      console.log(`\nğŸ“¨ Lead: ${turn.msg}`);
      console.log(`ğŸ¤– Sofia: ${result.reply}`);
      console.log(`ğŸ“Š AnÃ¡lise: ${JSON.stringify(result.analysis, null, 2)}`);

      expect(result.reply).toBeDefined();
      expect(result.reply.length).toBeGreaterThan(0);

      if (turn.expectedUrgency) {
        expect(result.analysis.urgency).toBe(turn.expectedUrgency);
      }

      if (turn.expectedIntent) {
        expect(result.analysis.intent).toBe(turn.expectedIntent);
      }

      // Pequeno delay entre mensagens
      await new Promise(r => setTimeout(r, 2000));
    }

    // Verificar lead final
    const prisma = new PrismaClient();
    const lead = await prisma.lead.findFirst({
      where: { phone: testPhone }
    });

    expect(lead).toBeDefined();
    expect(lead!.score).toBeGreaterThan(70); // Lead quente
    expect(lead!.budgetMax).toBeDefined();

    await prisma.$disconnect();
  }, 60000); // Timeout maior para E2E
});</code></pre>
                </div>

                <div class="command-box">
pnpm test:e2e
                </div>
            </section>

            <section id="scenarios">
                <h2>ğŸ“ CenÃ¡rios de Teste</h2>

                <div class="test-box">
                    <h4>CenÃ¡rio 1: Lead Quente â†’ ConversÃ£o</h4>
                    <ol>
                        <li>Lead envia: "Preciso urgente de apartamento 3 quartos"</li>
                        <li>Sistema detecta urgÃªncia alta</li>
                        <li>IA responde com opÃ§Ãµes</li>
                        <li>Lead visualiza imÃ³veis</li>
                        <li>Lead solicita agendamento</li>
                        <li>Sistema agenda visita automaticamente</li>
                        <li>Corretor Ã© notificado no Telegram</li>
                        <li>Lembretes sÃ£o enviados</li>
                        <li>Visita Ã© realizada</li>
                        <li>Feedback Ã© coletado</li>
                    </ol>
                    <p><strong>ValidaÃ§Ãµes:</strong></p>
                    <ul>
                        <li>âœ… Score aumenta progressivamente</li>
                        <li>âœ… NotificaÃ§Ãµes enviadas no momento certo</li>
                        <li>âœ… Contexto mantido entre mensagens</li>
                        <li>âœ… Agendamento criado no Google Calendar</li>
                    </ul>
                </div>

                <div class="test-box">
                    <h4>CenÃ¡rio 2: Lead Frio â†’ RecuperaÃ§Ã£o</h4>
                    <ol>
                        <li>Lead teve conversa inicial (score 60)</li>
                        <li>Para de responder por 10 dias</li>
                        <li>Sistema detecta lead frio</li>
                        <li>Mensagem de recuperaÃ§Ã£o Ã© enviada</li>
                        <li>Lead responde</li>
                        <li>Conversa Ã© retomada</li>
                    </ol>
                    <p><strong>ValidaÃ§Ãµes:</strong></p>
                    <ul>
                        <li>âœ… Lead Ã© identificado como frio</li>
                        <li>âœ… Mensagem de recuperaÃ§Ã£o Ã© personalizada</li>
                        <li>âœ… Score nÃ£o cai drasticamente</li>
                        <li>âœ… Contexto histÃ³rico Ã© preservado</li>
                    </ul>
                </div>

                <div class="test-box">
                    <h4>CenÃ¡rio 3: Multiple Leads SimultÃ¢neos</h4>
                    <ol>
                        <li>5 leads diferentes enviam mensagens ao mesmo tempo</li>
                        <li>Sistema processa todas em paralelo</li>
                        <li>Cada uma recebe resposta personalizada</li>
                        <li>Contextos nÃ£o se misturam</li>
                    </ol>
                    <p><strong>ValidaÃ§Ãµes:</strong></p>
                    <ul>
                        <li>âœ… Todas mensagens sÃ£o processadas</li>
                        <li>âœ… NÃ£o hÃ¡ mistura de contextos</li>
                        <li>âœ… Tempo de resposta < 10s por lead</li>
                        <li>âœ… Sem erros de concorrÃªncia</li>
                    </ul>
                </div>

                <div class="test-box">
                    <h4>CenÃ¡rio 4: AutomaÃ§Ãµes Funcionando</h4>
                    <ol>
                        <li>Sistema roda por 24 horas</li>
                        <li>Jobs cron executam conforme agendado</li>
                        <li>Follow-ups sÃ£o enviados</li>
                        <li>Scores sÃ£o atualizados</li>
                        <li>Lembretes sÃ£o disparados</li>
                    </ol>
                    <p><strong>ValidaÃ§Ãµes:</strong></p>
                    <ul>
                        <li>âœ… Todos os cron jobs executam</li>
                        <li>âœ… Sem duplicaÃ§Ã£o de mensagens</li>
                        <li>âœ… Logs sem erros</li>
                        <li>âœ… Performance estÃ¡vel</li>
                    </ul>
                </div>
            </section>

            <section id="performance">
                <h2>âš¡ Testes de Performance</h2>

                <h3>Teste de Carga</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>ğŸ“ apps/api/src/__tests__/performance/load-test.ts</span>
                        <button onclick="copyCode(this)">ğŸ“‹ Copiar</button>
                    </div>
                    <pre><code>import { MessageProcessorService } from '../../ai/services/message-processor.service';

describe('Performance: Load Test', () => {
  it('deve processar 50 mensagens em menos de 2 minutos', async () => {
    const processor = new MessageProcessorService();
    const startTime = Date.now();
    const promises: Promise<any>[] = [];

    // Simular 50 mensagens simultÃ¢neas
    for (let i = 0; i < 50; i++) {
      const promise = processor.processIncomingMessage(
        `5511${String(i).padStart(9, '9')}`,
        `Teste de carga nÃºmero ${i}`,
        'load-test'
      );
      promises.push(promise);
    }

    await Promise.all(promises);

    const elapsed = Date.now() - startTime;
    const elapsedSeconds = elapsed / 1000;

    console.log(`\nâ±ï¸ Tempo total: ${elapsedSeconds}s`);
    console.log(`ğŸ“Š Tempo mÃ©dio por mensagem: ${(elapsedSeconds / 50).toFixed(2)}s`);

    expect(elapsedSeconds).toBeLessThan(120); // Menos de 2 minutos
  }, 150000); // Timeout de 2.5 minutos
});</code></pre>
                </div>

                <div class="card card-success">
                    <h3>âœ… Benchmarks Esperados</h3>
                    <ul>
                        <li>Tempo de resposta mÃ©dio: &lt; 5 segundos</li>
                        <li>Processamento de mensagem: &lt; 3 segundos</li>
                        <li>AnÃ¡lise de sentimento: &lt; 2 segundos</li>
                        <li>CÃ¡lculo de score: &lt; 1 segundo</li>
                        <li>Throughput: 100+ mensagens/minuto</li>
                    </ul>
                </div>
            </section>

            <div class="card card-info" style="margin-top: 50px;">
                <h3>ğŸ‰ Checklist Final de Testes</h3>
                <ul>
                    <li>â˜ Todos os testes unitÃ¡rios passando</li>
                    <li>â˜ Testes de integraÃ§Ã£o sem erros</li>
                    <li>â˜ Pelo menos 1 teste E2E completo</li>
                    <li>â˜ Todos os cenÃ¡rios validados</li>
                    <li>â˜ Performance dentro dos benchmarks</li>
                    <li>â˜ Sem memory leaks</li>
                    <li>â˜ Logs sem erros crÃ­ticos</li>
                    <li>â˜ Coverage de cÃ³digo &gt; 70%</li>
                </ul>
                <p><strong>PrÃ³ximo passo:</strong> <a href="guia-deploy.html">Deploy para ProduÃ§Ã£o</a></p>
            </div>
        </div>

        <footer class="nav-footer">
            <a href="guia-fase3.html" class="btn-nav">â† Fase 3</a>
            <a href="guia-index.html" class="btn-nav">ğŸ  Ãndice</a>
            <a href="guia-deploy.html" class="btn-nav">Deploy â†’</a>
        </footer>
    </div>

    <script src="guia-scripts.js"></script>
</body>
</html>
