<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Negocia√ß√µes e Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section h2 { color: #2563eb; margin-bottom: 15px; font-size: 18px; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background: #1d4ed8; }
        button.secondary { background: #10b981; }
        button.secondary:hover { background: #059669; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        .result { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 6px; margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .result pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; color: #334155; }
        .success { background: #d1fae5; border-color: #10b981; }
        .error { background: #fee2e2; border-color: #ef4444; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #d1d5db; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
        .stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Negocia√ß√µes e Dashboard</h1>

        <div class="section">
            <h2>üìä Dashboard Overview</h2>
            <button onclick="getDashboard()">Buscar Dashboard</button>
            <div id="dashboard-result" class="result" style="display:none"></div>
            <div id="dashboard-stats" class="grid" style="margin-top: 20px;"></div>
        </div>

        <div class="section">
            <h2>üìà Funil de Vendas</h2>
            <button class="secondary" onclick="getFunil()">Buscar Funil</button>
            <div id="funil-result" class="result" style="display:none"></div>
        </div>

        <div class="section">
            <h2>üèÜ Performance de Corretores</h2>
            <button class="secondary" onclick="getPerformance()">Buscar Performance</button>
            <div id="performance-result" class="result" style="display:none"></div>
        </div>

        <div class="section">
            <h2>üìã Listar Negocia√ß√µes</h2>
            <button onclick="listarNegociacoes()">Listar Todas</button>
            <div id="list-result" class="result" style="display:none"></div>
        </div>

        <div class="section">
            <h2>‚ûï Criar Nova Negocia√ß√£o</h2>
            <div>
                <input type="text" id="lead_id" placeholder="ID do Lead (UUID)">
                <input type="text" id="imovel_id" placeholder="ID do Im√≥vel (UUID)">
                <input type="text" id="corretor_id" placeholder="ID do Corretor (UUID)">
                <input type="number" id="valor_proposta" placeholder="Valor Proposta (opcional)">
            </div>
            <button onclick="criarNegociacao()">Criar Negocia√ß√£o</button>
            <div id="create-result" class="result" style="display:none"></div>
        </div>

        <div class="section">
            <h2>üîÑ Mudar Status da Negocia√ß√£o</h2>
            <div>
                <input type="text" id="negociacao_id" placeholder="ID da Negocia√ß√£o (UUID)">
                <select id="novo_status">
                    <option value="">Selecione Status</option>
                    <option value="CONTATO">CONTATO</option>
                    <option value="VISITA_AGENDADA">VISITA_AGENDADA</option>
                    <option value="VISITA_REALIZADA">VISITA_REALIZADA</option>
                    <option value="PROPOSTA">PROPOSTA</option>
                    <option value="ANALISE_CREDITO">ANALISE_CREDITO</option>
                    <option value="CONTRATO">CONTRATO</option>
                    <option value="FECHADO">FECHADO</option>
                    <option value="PERDIDO">PERDIDO</option>
                    <option value="CANCELADO">CANCELADO</option>
                </select>
                <input type="number" id="valor_fechamento" placeholder="Valor Fechamento (se FECHADO)">
            </div>
            <button onclick="mudarStatus()">Mudar Status</button>
            <div id="status-result" class="result" style="display:none"></div>
        </div>

        <div class="section">
            <h2>üìä Estat√≠sticas de Negocia√ß√µes</h2>
            <button class="secondary" onclick="getStatsNegociacoes()">Buscar Estat√≠sticas</button>
            <div id="stats-result" class="result" style="display:none"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3333/api/v1';
        const token = localStorage.getItem('token');

        if (!token) {
            alert('Voc√™ precisa fazer login primeiro!');
            window.location.href = '/test-login.html';
        }

        async function getDashboard() {
            try {
                const response = await fetch(`${API_URL}/dashboard/overview`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('dashboard-result').style.display = 'block';
                document.getElementById('dashboard-result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                const statsHTML = `
                    <div class="stat-card">
                        <h3>Total de Leads</h3>
                        <div class="value">${data.resumo.totalLeads}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3>Negocia√ß√µes Fechadas</h3>
                        <div class="value">${data.resumo.negociacoesFechadas}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3>Taxa de Convers√£o</h3>
                        <div class="value">${data.resumo.taxaConversao}%</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h3>Valor Total</h3>
                        <div class="value">R$ ${data.financeiro.valorTotalFechamentos.toLocaleString('pt-BR')}</div>
                    </div>
                `;
                document.getElementById('dashboard-stats').innerHTML = statsHTML;
            } catch (error) {
                document.getElementById('dashboard-result').className = 'result error';
                document.getElementById('dashboard-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }

        async function getFunil() {
            try {
                const response = await fetch(`${API_URL}/dashboard/funil`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('funil-result').style.display = 'block';
                document.getElementById('funil-result').className = 'result success';
                document.getElementById('funil-result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('funil-result').style.display = 'block';
                document.getElementById('funil-result').className = 'result error';
                document.getElementById('funil-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }

        async function getPerformance() {
            try {
                const response = await fetch(`${API_URL}/dashboard/performance-corretores`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('performance-result').style.display = 'block';
                document.getElementById('performance-result').className = 'result success';
                document.getElementById('performance-result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('performance-result').style.display = 'block';
                document.getElementById('performance-result').className = 'result error';
                document.getElementById('performance-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }

        async function listarNegociacoes() {
            try {
                const response = await fetch(`${API_URL}/negociacoes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('list-result').style.display = 'block';
                document.getElementById('list-result').className = 'result success';
                document.getElementById('list-result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('list-result').style.display = 'block';
                document.getElementById('list-result').className = 'result error';
                document.getElementById('list-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }

        async function criarNegociacao() {
            const lead_id = document.getElementById('lead_id').value;
            const imovel_id = document.getElementById('imovel_id').value;
            const corretor_id = document.getElementById('corretor_id').value;
            const valor_proposta = document.getElementById('valor_proposta').value;

            if (!lead_id || !imovel_id || !corretor_id) {
                alert('Preencha pelo menos Lead, Im√≥vel e Corretor!');
                return;
            }

            try {
                const body = {
                    lead_id,
                    imovel_id,
                    corretor_id,
                };
                if (valor_proposta) body.valor_proposta = parseFloat(valor_proposta);

                const response = await fetch(`${API_URL}/negociacoes`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                
                document.getElementById('create-result').style.display = 'block';
                if (response.ok) {
                    document.getElementById('create-result').className = 'result success';
                    document.getElementById('create-result').innerHTML = `<pre>‚úÖ Negocia√ß√£o criada!\n\n${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    document.getElementById('create-result').className = 'result error';
                    document.getElementById('create-result').innerHTML = `<pre>‚ùå Erro: ${data.error}</pre>`;
                }
            } catch (error) {
                document.getElementById('create-result').style.display = 'block';
                document.getElementById('create-result').className = 'result error';
                document.getElementById('create-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }

        async function mudarStatus() {
            const negociacao_id = document.getElementById('negociacao_id').value;
            const status = document.getElementById('novo_status').value;
            const valor_fechamento = document.getElementById('valor_fechamento').value;

            if (!negociacao_id || !status) {
                alert('Preencha ID da negocia√ß√£o e novo status!');
                return;
            }

            try {
                const body = { status };
                if (valor_fechamento) body.valor_fechamento = parseFloat(valor_fechamento);

                const response = await fetch(`${API_URL}/negociacoes/${negociacao_id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                
                document.getElementById('status-result').style.display = 'block';
                if (response.ok) {
                    document.getElementById('status-result').className = 'result success';
                    document.getElementById('status-result').innerHTML = `<pre>‚úÖ Status alterado!\n\n${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    document.getElementById('status-result').className = 'result error';
                    document.getElementById('status-result').innerHTML = `<pre>‚ùå Erro: ${data.error}</pre>`;
                }
            } catch (error) {
                document.getElementById('status-result').style.display = 'block';
                document.getElementById('status-result').className = 'result error';
                document.getElementById('status-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }

        async function getStatsNegociacoes() {
            try {
                const response = await fetch(`${API_URL}/negociacoes/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                document.getElementById('stats-result').style.display = 'block';
                document.getElementById('stats-result').className = 'result success';
                document.getElementById('stats-result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('stats-result').style.display = 'block';
                document.getElementById('stats-result').className = 'result error';
                document.getElementById('stats-result').innerHTML = `<pre>Erro: ${error.message}</pre>`;
            }
        }
    </script>
</body>
</html>
