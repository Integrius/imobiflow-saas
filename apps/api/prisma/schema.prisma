// Schema Prisma - ImobiFlow
// Database: PostgreSQL 16

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY
// ============================================

model Tenant {
  id String @id @default(uuid())

  // Identificação
  nome           String
  slug           String  @unique
  subdominio     String? @unique
  dominio_custom String? @unique

  // Contato
  email    String
  telefone String?

  // Configurações
  logo_url      String?
  cores_tema    Json?
  configuracoes Json?

  // Plano e assinatura
  plano          PlanoTenant  @default(BASICO)
  status         StatusTenant @default(TRIAL)
  data_expiracao DateTime?

  // Limites por plano
  limite_usuarios   Int @default(3)
  limite_imoveis    Int @default(100)
  limite_storage_mb Int @default(1000)

  // Uso atual
  total_usuarios   Int @default(0)
  total_imoveis    Int @default(0)
  storage_usado_mb Int @default(0)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  users         User[]
  corretores    Corretor[]
  leads         Lead[]
  proprietarios Proprietario[]
  imoveis       Imovel[]
  negociacoes   Negociacao[]
  integracoes   Integracao[]
  automacoes    Automacao[]
  assinaturas   Assinatura[]
  messages      Message[]
  agendamentos  Agendamento[]

  @@index([slug])
  @@index([plano])
  @@index([status])
  @@map("tenants")
}

enum PlanoTenant {
  BASICO
  PRO
  ENTERPRISE
  CUSTOM
}

enum StatusTenant {
  TRIAL
  ATIVO
  INATIVO
  SUSPENSO
  CANCELADO
}

// ============================================
// ASSINATURAS
// ============================================

model Assinatura {
  id String @id @default(uuid())

  // Tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Plano e valor
  plano         PlanoTenant
  valor_mensal  Decimal       @db.Decimal(10, 2)
  valor_anual   Decimal?      @db.Decimal(10, 2)
  periodicidade Periodicidade @default(MENSAL)

  // Status
  status StatusAssinatura @default(PENDENTE)

  // Datas
  inicio           DateTime
  fim              DateTime?
  proxima_cobranca DateTime?

  // Pagamento
  gateway          String?
  gateway_id       String?
  metodo_pagamento String?

  // Histórico
  historico Json[]

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@index([status])
  @@map("assinaturas")
}

enum Periodicidade {
  MENSAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
}

enum StatusAssinatura {
  PENDENTE
  ATIVA
  CANCELADA
  SUSPENSA
  VENCIDA
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  nome       String
  email      String
  senha_hash String?
  google_id  String?  @unique
  tipo       UserType @default(CORRETOR)
  ativo      Boolean  @default(true)

  // Timestamps
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  ultimo_login DateTime?

  // Relacionamentos
  corretor Corretor?

  @@unique([tenant_id, email])
  @@index([tenant_id])
  @@index([email])
  @@map("users")
}

enum UserType {
  ADMIN
  GESTOR
  CORRETOR
}

// ============================================
// CORRETORES
// ============================================

model Corretor {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  creci    String
  telefone String
  foto_url String?

  // Notificações
  telegram_chat_id String? // ID do chat Telegram para notificações

  // Configurações
  especializacoes String[]
  meta_mensal     Decimal? @db.Decimal(10, 2)
  meta_anual      Decimal? @db.Decimal(10, 2)
  comissao_padrao Decimal  @default(3.00) @db.Decimal(5, 2)

  // Performance
  performance_score Int   @default(0)
  disponibilidade   Json?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  leads               Lead[]
  negociacoes         Negociacao[]
  imoveis_responsavel Imovel[]
  agendamentos        Agendamento[]

  @@unique([tenant_id, creci])
  @@index([tenant_id])
  @@map("corretores")
}

// ============================================
// LEADS
// ============================================

model Lead {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Dados pessoais
  nome     String
  email    String?
  telefone String
  cpf      String?

  // Origem e qualificação
  origem      OrigemLead
  temperatura Temperatura @default(FRIO)
  score       Int         @default(0)

  // Interesse (LEGADO - manter para compatibilidade)
  interesse   Json?
  observacoes String? @db.Text

  // ==========================================
  // DADOS DO FORMULÁRIO DE CAPTURA
  // ==========================================

  // Tipo de negócio desejado
  tipo_negocio TipoNegocio? // COMPRA, ALUGUEL, TEMPORADA

  // Tipo de imóvel desejado (melhor que property_type genérico)
  tipo_imovel_desejado TipoImovel? // APARTAMENTO, CASA, LOJA, etc

  // Faixa de valor
  valor_minimo Decimal? @db.Decimal(10, 2)
  valor_maximo Decimal? @db.Decimal(10, 2)

  // Localização detalhada
  estado     String? // UF (ex: SP, RJ)
  municipio  String? // Nome da cidade
  bairro     String? // Nome do bairro
  complemento_localizacao String? @db.Text // Detalhes adicionais

  // Características desejadas
  quartos_min    Int? // Mínimo de quartos
  quartos_max    Int? // Máximo de quartos
  vagas_min      Int? // Mínimo de vagas
  vagas_max      Int? // Máximo de vagas
  area_minima    Decimal? @db.Decimal(10, 2) // Área mínima em m²
  aceita_pets    Boolean? // Aceita animais de estimação

  // Timeline de interações
  timeline Json[]

  // Atribuição
  corretor_id String?
  corretor    Corretor? @relation(fields: [corretor_id], references: [id], onDelete: SetNull)

  // ==========================================
  // CAMPOS PARA SISTEMA DE IA
  // ==========================================

  // Preferências do lead identificadas pela IA
  property_type String? // tipo de imóvel (apartamento, casa, etc)
  location      String? // localização desejada
  bedrooms      Int? // número de quartos desejado
  budget        Decimal? @db.Decimal(10, 2) // orçamento máximo

  // Análise comportamental da IA
  urgency   UrgencyLevel? // nível de urgência
  sentiment Sentiment? // sentimento nas interações
  intent    Intent? // última intenção detectada

  // Controle IA
  ai_enabled          Boolean @default(true) // IA habilitada para este lead?
  escalated_to_broker Boolean @default(false) // Escalado para corretor?
  escalation_reason   String? @db.Text // Por que foi escalado?

  // Timestamps
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  ultimo_contato DateTime?

  // Relacionamentos
  negociacoes  Negociacao[]
  messages     Message[] // Mensagens da conversa
  agendamentos Agendamento[]

  @@index([tenant_id])
  @@index([corretor_id])
  @@index([origem])
  @@index([temperatura])
  @@index([score])
  @@map("leads")
}

enum OrigemLead {
  SITE
  PORTAL
  WHATSAPP
  TELEFONE
  INDICACAO
  REDES_SOCIAIS
  EVENTO
  OUTRO
}

enum Temperatura {
  QUENTE
  MORNO
  FRIO
}

// ============================================
// MENSAGENS (Sistema IA)
// ============================================

model Message {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Lead relacionado
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  // Conteúdo
  content      String  @db.Text
  is_from_lead Boolean // true = lead enviou, false = IA respondeu

  // Plataforma
  platform Platform @default(WHATSAPP)

  // Status de entrega
  status MessageStatus @default(SENT)

  // Análise IA (opcional)
  ai_analysis     Json? // Armazena análise completa da IA
  ai_score_impact Int? // Impacto no score (-10 a +10)

  // Timestamps
  created_at   DateTime  @default(now())
  delivered_at DateTime?
  read_at      DateTime?

  @@index([tenant_id])
  @@index([lead_id])
  @@index([created_at])
  @@index([platform])
  @@map("messages")
}

enum Platform {
  WHATSAPP
  TELEGRAM
  WEBCHAT
  SMS
  EMAIL
}

enum MessageStatus {
  PENDING // Aguardando envio
  SENT // Enviada
  DELIVERED // Entregue
  READ // Lida
  FAILED // Falhou
}

// ============================================
// PROPRIETÁRIOS
// ============================================

model Proprietario {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Dados pessoais
  nome        String
  cpf_cnpj    String
  tipo_pessoa TipoPessoa @default(FISICA)

  // Contato
  email               String?
  telefone            String
  telefone_secundario String?
  contato             Json?

  // Configurações financeiras
  forma_pagamento     String  @default("PIX")
  percentual_comissao Decimal @default(5.00) @db.Decimal(5, 2)
  banco               Json?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  imoveis Imovel[]

  @@unique([tenant_id, cpf_cnpj])
  @@index([tenant_id])
  @@map("proprietarios")
}

enum TipoPessoa {
  FISICA
  JURIDICA
}

// ============================================
// IMÓVEIS
// ============================================

model Imovel {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  codigo String

  // Tipo e categoria
  tipo      TipoImovel
  categoria CategoriaImovel
  status    StatusImovel    @default(DISPONIVEL)

  // Endereço
  endereco Json

  // Características
  caracteristicas Json

  // Descrição
  titulo       String
  descricao    String   @db.Text
  diferenciais String[]

  // Mídia
  fotos        String[]
  video_url    String?
  tour_360_url String?

  // Documentos
  documentos String[]

  // Valores
  preco      Decimal  @db.Decimal(10, 2)
  condominio Decimal? @db.Decimal(10, 2)
  iptu       Decimal? @db.Decimal(10, 2)

  // Validação
  ultima_validacao DateTime?
  validado_por     String?

  // Proprietário
  proprietario_id String
  proprietario    Proprietario @relation(fields: [proprietario_id], references: [id], onDelete: Restrict)

  // Corretor Responsável
  corretor_responsavel_id String?
  corretor_responsavel    Corretor? @relation(fields: [corretor_responsavel_id], references: [id], onDelete: SetNull)
  historico_corretores    Json[] // Histórico de trocas de corretor

  // Timestamps
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  publicado_em DateTime?

  // Relacionamentos
  negociacoes  Negociacao[]
  agendamentos Agendamento[]

  @@unique([tenant_id, codigo])
  @@index([tenant_id])
  @@index([tipo])
  @@index([categoria])
  @@index([status])
  @@index([proprietario_id])
  @@index([corretor_responsavel_id])
  @@map("imoveis")
}

enum TipoImovel {
  APARTAMENTO
  CASA
  TERRENO
  COMERCIAL
  RURAL
  CHACARA
  SOBRADO
  COBERTURA
  LOFT
  KITNET
}

enum CategoriaImovel {
  VENDA
  LOCACAO
  TEMPORADA
}

enum TipoNegocio {
  COMPRA
  ALUGUEL
  TEMPORADA
  VENDA // Para quem quer vender
}

enum StatusImovel {
  DISPONIVEL
  RESERVADO
  VENDIDO
  ALUGADO
  INATIVO
  MANUTENCAO
}

// ============================================
// NEGOCIAÇÕES
// ============================================

model Negociacao {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  codigo String

  // Relacionamentos principais
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Restrict)

  imovel_id String
  imovel    Imovel @relation(fields: [imovel_id], references: [id], onDelete: Restrict)

  corretor_id String
  corretor    Corretor @relation(fields: [corretor_id], references: [id], onDelete: Restrict)

  // Status
  status StatusNegociacao @default(CONTATO)

  // Proposta
  valor_proposta Decimal? @db.Decimal(10, 2)
  valor_aprovado Decimal? @db.Decimal(10, 2)
  condicoes      Json?

  // Comissões
  comissoes      Json[]
  valor_comissao Decimal? @db.Decimal(10, 2)

  // Documentos
  documentos   String[]
  contrato_url String?

  // Timeline
  timeline Json[]

  // Datas importantes
  data_proposta   DateTime?
  data_contrato   DateTime?
  data_fechamento DateTime?

  // Motivo de perda
  motivo_perda String? @db.Text

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tenant_id, codigo])
  @@index([tenant_id])
  @@index([lead_id])
  @@index([imovel_id])
  @@index([corretor_id])
  @@index([status])
  @@map("negociacoes")
}

enum StatusNegociacao {
  CONTATO
  VISITA_AGENDADA
  VISITA_REALIZADA
  PROPOSTA
  ANALISE_CREDITO
  CONTRATO
  FECHADO
  PERDIDO
  CANCELADO
}

// ============================================
// AGENDAMENTOS DE VISITAS
// ============================================

model Agendamento {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Relacionamentos principais
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  imovel_id String
  imovel    Imovel @relation(fields: [imovel_id], references: [id], onDelete: Restrict)

  corretor_id String
  corretor    Corretor @relation(fields: [corretor_id], references: [id], onDelete: Restrict)

  // Data e horário
  data_visita DateTime
  duracao_minutos Int @default(60) // Duração estimada em minutos

  // Status
  status StatusAgendamento @default(PENDENTE)

  // Detalhes
  observacoes String? @db.Text
  tipo_visita TipoVisita @default(PRESENCIAL)

  // Confirmação
  confirmado_lead     Boolean   @default(false)
  confirmado_corretor Boolean   @default(false)
  data_confirmacao    DateTime?

  // Realização
  realizado        Boolean   @default(false)
  data_realizacao  DateTime?
  feedback_lead    String?   @db.Text
  feedback_corretor String?  @db.Text
  nota_lead        Int? // 1-5 estrelas

  // Cancelamento
  motivo_cancelamento String? @db.Text
  cancelado_por       String? // user_id de quem cancelou
  data_cancelamento   DateTime?

  // Lembretes enviados
  lembrete_24h_enviado Boolean @default(false)
  lembrete_1h_enviado  Boolean @default(false)

  // Timeline de eventos
  timeline Json[]

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@index([lead_id])
  @@index([imovel_id])
  @@index([corretor_id])
  @@index([data_visita])
  @@index([status])
  @@map("agendamentos")
}

enum StatusAgendamento {
  PENDENTE      // Aguardando confirmação
  CONFIRMADO    // Confirmado por ambas as partes
  REALIZADO     // Visita realizada
  CANCELADO     // Cancelado
  NAO_COMPARECEU // Lead não compareceu
}

enum TipoVisita {
  PRESENCIAL // Visita presencial no imóvel
  VIRTUAL    // Visita virtual (vídeo chamada)
  HIBRIDA    // Combinação de presencial e virtual
}

// ============================================
// INTEGRAÇÕES
// ============================================

model Integracao {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  portal PortalIntegracao
  status StatusIntegracao @default(INATIVO)

  // Configuração
  configuracao Json

  // Sincronização
  ultima_sync    DateTime?
  proxima_sync   DateTime?
  intervalo_sync Int       @default(60)

  // Logs
  logs          Json[]
  total_sucesso Int    @default(0)
  total_erro    Int    @default(0)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tenant_id, portal])
  @@index([tenant_id])
  @@map("integracoes")
}

enum PortalIntegracao {
  ZAP_IMOVEIS
  VIVA_REAL
  OLX
  IMOVELWEB
  CHAVES_NA_MAO
  CUSTOM
}

enum StatusIntegracao {
  ATIVO
  INATIVO
  ERRO
  MANUTENCAO
}

// ============================================
// AUTOMAÇÕES
// ============================================

model Automacao {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  nome      String
  descricao String? @db.Text

  // Configuração
  trigger   String
  condicoes Json[]
  acoes     Json[]

  // Estado
  ativo Boolean @default(true)

  // Execuções
  execucoes       Json[]
  total_execucoes Int       @default(0)
  ultima_execucao DateTime?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@map("automacoes")
}

// ============================================
// ENUMS PARA SISTEMA DE IA
// ============================================

enum UrgencyLevel {
  BAIXA
  MEDIA
  ALTA
}

enum Sentiment {
  POSITIVO
  NEUTRO
  NEGATIVO
}

enum Intent {
  INFORMACAO // Apenas buscando informações
  AGENDAMENTO // Quer agendar visita
  NEGOCIACAO // Quer negociar/fazer proposta
  RECLAMACAO // Está reclamando
  OUTRO // Outros
}
