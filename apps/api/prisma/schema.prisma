// Schema Prisma - ImobiFlow
// Database: PostgreSQL 16

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY
// ============================================

model Tenant {
  id String @id @default(uuid())

  // Identificação
  nome           String
  slug           String  @unique
  subdominio     String? @unique
  dominio_custom String? @unique

  // Contato
  email    String
  telefone String?

  // Configurações
  logo_url      String?
  cores_tema    Json?
  configuracoes Json?

  // Plano e assinatura
  plano          PlanoTenant  @default(BASICO)
  status         StatusTenant @default(TRIAL)
  data_expiracao DateTime?
  data_exportacao_dados DateTime? // Data da última exportação de dados
  email_5dias_enviado Boolean @default(false) // Email de aviso 5 dias antes enviado
  email_2dias_enviado Boolean @default(false) // Email de aviso 2 dias antes enviado

  // Limites por plano
  limite_usuarios   Int @default(3)
  limite_imoveis    Int @default(100)
  limite_storage_mb Int @default(1000)

  // Uso atual
  total_usuarios   Int @default(0)
  total_imoveis    Int @default(0)
  storage_usado_mb Int @default(0)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  users            User[]
  corretores       Corretor[]
  leads            Lead[]
  proprietarios    Proprietario[]
  imoveis          Imovel[]
  negociacoes      Negociacao[]
  propostas        Proposta[]
  integracoes      Integracao[]
  automacoes       Automacao[]
  assinaturas      Assinatura[]
  messages         Message[]
  agendamentos     Agendamento[]
  activity_logs    ActivityLog[]
  lead_interactions LeadInteraction[]
  metas            Meta[]
  whatsapp_config  WhatsAppConfig?
  notifications    Notification[]

  @@index([slug])
  @@index([plano])
  @@index([status])
  @@map("tenants")
}

enum PlanoTenant {
  BASICO
  PRO
  ENTERPRISE
  CUSTOM
}

enum StatusTenant {
  TRIAL
  ATIVO
  INATIVO
  SUSPENSO
  CANCELADO
}

// ============================================
// ASSINATURAS
// ============================================

model Assinatura {
  id String @id @default(uuid())

  // Tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Plano e valor
  plano         PlanoTenant
  valor_mensal  Decimal       @db.Decimal(10, 2)
  valor_anual   Decimal?      @db.Decimal(10, 2)
  periodicidade Periodicidade @default(MENSAL)

  // Status
  status StatusAssinatura @default(PENDENTE)

  // Datas
  inicio           DateTime
  fim              DateTime?
  proxima_cobranca DateTime?

  // Pagamento
  gateway          String?
  gateway_id       String?
  metodo_pagamento String?

  // Histórico
  historico Json[]

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@index([status])
  @@map("assinaturas")
}

enum Periodicidade {
  MENSAL
  TRIMESTRAL
  SEMESTRAL
  ANUAL
}

enum StatusAssinatura {
  PENDENTE
  ATIVA
  CANCELADA
  SUSPENSA
  VENCIDA
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

model User {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  nome            String
  email           String
  senha_hash      String?
  google_id       String?  @unique
  tipo            UserType @default(CORRETOR)
  ativo           Boolean  @default(true)
  primeiro_acesso Boolean  @default(true) // True = usuário precisa definir senha
  status_conta    StatusConta @default(ATIVO) // Status da conta: ATIVO, SUSPENSO, CANCELADO

  // Senha temporária (primeiro acesso)
  senha_temporaria     String?   // Senha em texto plano para envio (apenas temporária)
  senha_temp_expira_em DateTime? // Expiração da senha temporária (12 horas)
  senha_temp_usada     Boolean   @default(false) // Controle se senha temporária foi usada

  // Timestamps
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  ultimo_login DateTime?

  // Relacionamentos
  corretor      Corretor?
  activity_logs ActivityLog[]
  notifications Notification[]

  @@unique([tenant_id, email])
  @@index([tenant_id])
  @@index([email])
  @@map("users")
}

enum UserType {
  ADMIN
  GESTOR
  CORRETOR
}

enum StatusConta {
  ATIVO
  SUSPENSO
  CANCELADO
}

// ============================================
// RECUPERAÇÃO DE SENHA
// ============================================

model PasswordResetToken {
  id String @id @default(uuid())

  // Dados do token
  user_id String
  email   String
  token   String @unique // Token de 6 dígitos ou UUID
  expires DateTime // Expira em 5 minutos

  // Controle de uso
  usado  Boolean   @default(false)
  usado_em DateTime?

  // Timestamps
  created_at DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([expires])
  @@map("password_reset_tokens")
}

// ============================================
// CORRETORES
// ============================================

model Corretor {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  user_id String @unique
  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  creci    String
  telefone String
  foto_url String?

  // Notificações
  telegram_chat_id String? // ID do chat Telegram para notificações

  // Configurações
  especializacoes String[]
  meta_mensal     Decimal? @db.Decimal(10, 2)
  meta_anual      Decimal? @db.Decimal(10, 2)
  comissao_padrao Decimal  @default(3.00) @db.Decimal(5, 2)

  // Performance
  performance_score Int   @default(0)
  disponibilidade   Json?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  leads               Lead[]
  negociacoes         Negociacao[]
  propostas           Proposta[]
  imoveis_responsavel Imovel[]
  agendamentos        Agendamento[]
  metas               Meta[]

  @@unique([tenant_id, creci])
  @@index([tenant_id])
  @@map("corretores")
}

// ============================================
// LEADS
// ============================================

model Lead {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Dados pessoais
  nome     String
  email    String?
  telefone String
  cpf      String?

  // Origem e qualificação
  origem      OrigemLead
  temperatura Temperatura @default(FRIO)
  score       Int         @default(0)

  // Interesse (LEGADO - manter para compatibilidade)
  interesse   Json?
  observacoes String? @db.Text

  // ==========================================
  // DADOS DO FORMULÁRIO DE CAPTURA
  // ==========================================

  // Tipo de negócio desejado
  tipo_negocio TipoNegocio? // COMPRA, ALUGUEL, TEMPORADA

  // Tipo de imóvel desejado (melhor que property_type genérico)
  tipo_imovel_desejado TipoImovel? // APARTAMENTO, CASA, LOJA, etc

  // Faixa de valor
  valor_minimo Decimal? @db.Decimal(10, 2)
  valor_maximo Decimal? @db.Decimal(10, 2)

  // Localização detalhada
  estado     String? // UF (ex: SP, RJ)
  municipio  String? // Nome da cidade
  bairro     String? // Nome do bairro
  complemento_localizacao String? @db.Text // Detalhes adicionais

  // Características desejadas
  quartos_min    Int? // Mínimo de quartos
  quartos_max    Int? // Máximo de quartos
  vagas_min      Int? // Mínimo de vagas
  vagas_max      Int? // Máximo de vagas
  area_minima    Decimal? @db.Decimal(10, 2) // Área mínima em m²
  aceita_pets    Boolean? // Aceita animais de estimação

  // Timeline de interações
  timeline Json[]

  // Atribuição
  corretor_id String?
  corretor    Corretor? @relation(fields: [corretor_id], references: [id], onDelete: SetNull)

  // ==========================================
  // CAMPOS PARA SISTEMA DE IA
  // ==========================================

  // Preferências do lead identificadas pela IA
  property_type String? // tipo de imóvel (apartamento, casa, etc)
  location      String? // localização desejada
  bedrooms      Int? // número de quartos desejado
  budget        Decimal? @db.Decimal(10, 2) // orçamento máximo

  // Análise comportamental da IA
  urgency   UrgencyLevel? // nível de urgência
  sentiment Sentiment? // sentimento nas interações
  intent    Intent? // última intenção detectada

  // Controle IA
  ai_enabled          Boolean @default(true) // IA habilitada para este lead?
  ai_qualificacao     Json? // Análise completa da IA Sofia
  escalated_to_broker Boolean @default(false) // Escalado para corretor?
  escalation_reason   String? @db.Text // Por que foi escalado?

  // Timestamps
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  ultimo_contato DateTime?

  // ==========================================
  // INSIGHT ENGINE - Sofia IA
  // ==========================================
  last_interaction_at DateTime? // Data da última interação (otimização para queries de "leads esquecidos")

  // Relacionamentos
  negociacoes  Negociacao[]
  propostas    Proposta[]
  messages     Message[] // Mensagens da conversa
  agendamentos Agendamento[]
  interactions LeadInteraction[] // Histórico de interações

  @@index([tenant_id])
  @@index([corretor_id])
  @@index([origem])
  @@index([temperatura])
  @@index([score])
  @@index([last_interaction_at]) // Índice para queries de leads esquecidos
  @@map("leads")
}

enum OrigemLead {
  SITE
  PORTAL
  WHATSAPP
  TELEFONE
  INDICACAO
  REDES_SOCIAIS
  EVENTO
  OUTRO
}

enum Temperatura {
  QUENTE
  MORNO
  FRIO
}

// ============================================
// INTERAÇÕES DE LEADS (Insight Engine - Sofia)
// ============================================

model LeadInteraction {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Lead relacionado
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  // Tipo da interação
  tipo      TipoInteracao
  direcao   DirecaoInteracao // ENTRADA (cliente) ou SAIDA (corretor)

  // Conteúdo
  conteudo    String? @db.Text // Resumo ou corpo da mensagem
  sentimento  SentimentoInteracao @default(NEUTRO) // Classificação da IA

  // Metadados opcionais
  duracao_minutos Int?    // Para ligações
  corretor_id     String? // Quem registrou (se manual)
  automatico      Boolean @default(false) // Se foi registrado automaticamente (webhook)

  // Timestamps
  created_at DateTime @default(now())

  @@index([tenant_id])
  @@index([lead_id])
  @@index([tipo])
  @@index([created_at])
  @@map("lead_interactions")
}

enum TipoInteracao {
  WHATSAPP
  EMAIL
  LIGACAO
  VISITA
  NOTA // Anotação manual do corretor
  SMS
  TELEGRAM
}

enum DirecaoInteracao {
  ENTRADA  // Cliente enviou/falou
  SAIDA    // Corretor enviou/falou
}

enum SentimentoInteracao {
  POSITIVO
  NEUTRO
  NEGATIVO
}

// ============================================
// MENSAGENS (Sistema IA)
// ============================================

model Message {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Lead relacionado
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  // Conteúdo
  content      String  @db.Text
  is_from_lead Boolean // true = lead enviou, false = IA respondeu

  // Plataforma
  platform Platform @default(WHATSAPP)

  // Status de entrega
  status MessageStatus @default(SENT)

  // Twilio/External integration
  external_id   String? // MessageSid do Twilio ou ID externo
  external_from String? // Número de origem (whatsapp:+5511...)
  external_to   String? // Número de destino
  media_url     String? // URL de mídia anexada
  media_type    String? // Tipo da mídia (image/jpeg, etc)
  profile_name  String? // Nome do perfil WhatsApp do remetente

  // Análise IA (opcional)
  ai_analysis     Json? // Armazena análise completa da IA
  ai_score_impact Int? // Impacto no score (-10 a +10)

  // Timestamps
  created_at   DateTime  @default(now())
  delivered_at DateTime?
  read_at      DateTime?

  @@index([tenant_id])
  @@index([lead_id])
  @@index([created_at])
  @@index([platform])
  @@index([external_id])
  @@map("messages")
}

enum Platform {
  WHATSAPP
  TELEGRAM
  WEBCHAT
  SMS
  EMAIL
}

enum MessageStatus {
  PENDING // Aguardando envio
  SENT // Enviada
  DELIVERED // Entregue
  READ // Lida
  FAILED // Falhou
}

// ============================================
// PROPRIETÁRIOS
// ============================================

model Proprietario {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Dados pessoais
  nome        String
  cpf_cnpj    String
  tipo_pessoa TipoPessoa @default(FISICA)

  // Contato
  email               String?
  telefone            String
  telefone_secundario String?
  contato             Json?

  // Configurações financeiras
  forma_pagamento     String  @default("PIX")
  percentual_comissao Decimal @default(5.00) @db.Decimal(5, 2)
  banco               Json?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relacionamentos
  imoveis Imovel[]

  @@unique([tenant_id, cpf_cnpj])
  @@index([tenant_id])
  @@map("proprietarios")
}

enum TipoPessoa {
  FISICA
  JURIDICA
}

// ============================================
// IMÓVEIS
// ============================================

model Imovel {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  codigo String

  // Tipo e categoria
  tipo      TipoImovel
  categoria CategoriaImovel
  status    StatusImovel    @default(DISPONIVEL)

  // Endereço
  endereco Json

  // Características
  caracteristicas Json

  // Descrição
  titulo       String
  descricao    String   @db.Text
  diferenciais String[]

  // Mídia
  fotos        String[]
  video_url    String?
  tour_360_url String?

  // Documentos
  documentos String[]

  // Valores
  preco      Decimal  @db.Decimal(10, 2)
  condominio Decimal? @db.Decimal(10, 2)
  iptu       Decimal? @db.Decimal(10, 2)

  // Validação
  ultima_validacao DateTime?
  validado_por     String?

  // Proprietário
  proprietario_id String
  proprietario    Proprietario @relation(fields: [proprietario_id], references: [id], onDelete: Restrict)

  // Corretor Responsável
  corretor_responsavel_id String?
  corretor_responsavel    Corretor? @relation(fields: [corretor_responsavel_id], references: [id], onDelete: SetNull)
  historico_corretores    Json[] // Histórico de trocas de corretor

  // Timestamps
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  publicado_em DateTime?

  // Relacionamentos
  negociacoes  Negociacao[]
  propostas    Proposta[]
  agendamentos Agendamento[]

  @@unique([tenant_id, codigo])
  @@index([tenant_id])
  @@index([tipo])
  @@index([categoria])
  @@index([status])
  @@index([proprietario_id])
  @@index([corretor_responsavel_id])
  @@map("imoveis")
}

enum TipoImovel {
  APARTAMENTO
  CASA
  TERRENO
  COMERCIAL
  RURAL
  CHACARA
  SOBRADO
  COBERTURA
  LOFT
  KITNET
}

enum CategoriaImovel {
  VENDA
  LOCACAO
  TEMPORADA
}

enum TipoNegocio {
  COMPRA
  ALUGUEL
  TEMPORADA
  VENDA // Para quem quer vender
}

enum StatusImovel {
  DISPONIVEL
  RESERVADO
  VENDIDO
  ALUGADO
  INATIVO
  MANUTENCAO
}

// ============================================
// NEGOCIAÇÕES
// ============================================

model Negociacao {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  codigo String

  // Relacionamentos principais
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Restrict)

  imovel_id String
  imovel    Imovel @relation(fields: [imovel_id], references: [id], onDelete: Restrict)

  corretor_id String
  corretor    Corretor @relation(fields: [corretor_id], references: [id], onDelete: Restrict)

  // Status
  status StatusNegociacao @default(CONTATO)

  // Proposta
  valor_proposta Decimal? @db.Decimal(10, 2)
  valor_aprovado Decimal? @db.Decimal(10, 2)
  valor_final    Decimal? @db.Decimal(10, 2) // Valor real de fechamento da negociação
  condicoes      Json?

  // Comissões
  comissoes      Json[]
  valor_comissao Decimal? @db.Decimal(10, 2)

  // Documentos
  documentos   String[]
  contrato_url String?

  // Timeline
  timeline Json[]

  // Datas importantes
  data_proposta   DateTime?
  data_contrato   DateTime?
  data_fechamento DateTime?

  // Motivo de perda
  motivo_perda String? @db.Text

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tenant_id, codigo])
  @@index([tenant_id])
  @@index([lead_id])
  @@index([imovel_id])
  @@index([corretor_id])
  @@index([status])
  @@map("negociacoes")
}

enum StatusNegociacao {
  CONTATO
  VISITA_AGENDADA
  VISITA_REALIZADA
  PROPOSTA
  ANALISE_CREDITO
  CONTRATO
  FECHADO
  PERDIDO
  CANCELADO
}

// ============================================
// PROPOSTAS PARA IMÓVEIS
// ============================================

model Proposta {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Relacionamentos
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  imovel_id String
  imovel    Imovel @relation(fields: [imovel_id], references: [id], onDelete: Restrict)

  corretor_id String?
  corretor    Corretor? @relation(fields: [corretor_id], references: [id], onDelete: SetNull)

  // Valor da proposta
  valor Decimal @db.Decimal(10, 2)

  // Status
  status StatusProposta @default(PENDENTE)

  // Observações do lead
  observacoes String? @db.Text

  // Resposta do corretor/proprietário
  resposta          String?   @db.Text
  data_resposta     DateTime?
  respondido_por_id String? // user_id

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tenant_id, lead_id, imovel_id]) // Um lead só pode ter uma proposta ativa por imóvel
  @@index([tenant_id])
  @@index([lead_id])
  @@index([imovel_id])
  @@index([status])
  @@map("propostas")
}

enum StatusProposta {
  PENDENTE   // Aguardando resposta
  ACEITA     // Proposta aceita
  RECUSADA   // Proposta recusada
  CONTRA     // Contraproposta feita
  CANCELADA  // Cancelada pelo lead
}

// ============================================
// AGENDAMENTOS DE VISITAS
// ============================================

model Agendamento {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Relacionamentos principais
  lead_id String
  lead    Lead   @relation(fields: [lead_id], references: [id], onDelete: Cascade)

  imovel_id String
  imovel    Imovel @relation(fields: [imovel_id], references: [id], onDelete: Restrict)

  corretor_id String
  corretor    Corretor @relation(fields: [corretor_id], references: [id], onDelete: Restrict)

  // Data e horário
  data_visita DateTime
  duracao_minutos Int @default(60) // Duração estimada em minutos

  // Status
  status StatusAgendamento @default(PENDENTE)

  // Detalhes
  observacoes String? @db.Text
  tipo_visita TipoVisita @default(PRESENCIAL)

  // Confirmação
  confirmado_lead     Boolean   @default(false)
  confirmado_corretor Boolean   @default(false)
  data_confirmacao    DateTime?

  // Realização
  realizado        Boolean   @default(false)
  data_realizacao  DateTime?
  feedback_lead    String?   @db.Text
  feedback_corretor String?  @db.Text
  nota_lead        Int? // 1-5 estrelas

  // Cancelamento
  motivo_cancelamento String? @db.Text
  cancelado_por       String? // user_id de quem cancelou
  data_cancelamento   DateTime?

  // Lembretes enviados
  lembrete_24h_enviado Boolean @default(false)
  lembrete_1h_enviado  Boolean @default(false)

  // Timeline de eventos
  timeline Json[]

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@index([lead_id])
  @@index([imovel_id])
  @@index([corretor_id])
  @@index([data_visita])
  @@index([status])
  @@map("agendamentos")
}

enum StatusAgendamento {
  PENDENTE      // Aguardando confirmação
  CONFIRMADO    // Confirmado por ambas as partes
  REALIZADO     // Visita realizada
  CANCELADO     // Cancelado
  NAO_COMPARECEU // Lead não compareceu
}

enum TipoVisita {
  PRESENCIAL // Visita presencial no imóvel
  VIRTUAL    // Visita virtual (vídeo chamada)
  HIBRIDA    // Combinação de presencial e virtual
}

// ============================================
// INTEGRAÇÕES
// ============================================

model Integracao {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  portal PortalIntegracao
  status StatusIntegracao @default(INATIVO)

  // Configuração
  configuracao Json

  // Sincronização
  ultima_sync    DateTime?
  proxima_sync   DateTime?
  intervalo_sync Int       @default(60)

  // Logs
  logs          Json[]
  total_sucesso Int    @default(0)
  total_erro    Int    @default(0)

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tenant_id, portal])
  @@index([tenant_id])
  @@map("integracoes")
}

enum PortalIntegracao {
  ZAP_IMOVEIS
  VIVA_REAL
  OLX
  IMOVELWEB
  CHAVES_NA_MAO
  CUSTOM
}

enum StatusIntegracao {
  ATIVO
  INATIVO
  ERRO
  MANUTENCAO
}

// ============================================
// AUTOMAÇÕES
// ============================================

model Automacao {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  nome      String
  descricao String? @db.Text

  // Configuração
  trigger   String
  condicoes Json[]
  acoes     Json[]

  // Estado
  ativo Boolean @default(true)

  // Execuções
  execucoes       Json[]
  total_execucoes Int       @default(0)
  ultima_execucao DateTime?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@map("automacoes")
}

// ============================================
// ENUMS PARA SISTEMA DE IA
// ============================================

enum UrgencyLevel {
  BAIXA
  MEDIA
  ALTA
}

enum Sentiment {
  POSITIVO
  NEUTRO
  NEGATIVO
}

enum Intent {
  INFORMACAO // Apenas buscando informações
  AGENDAMENTO // Quer agendar visita
  NEGOCIACAO // Quer negociar/fazer proposta
  RECLAMACAO // Está reclamando
  OUTRO // Outros
}

// ============================================
// METAS DE CORRETORES
// ============================================

model Meta {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Corretor alvo da meta
  corretor_id String
  corretor    Corretor @relation(fields: [corretor_id], references: [id], onDelete: Cascade)

  // Período da meta
  mes Int // 1-12
  ano Int // Ex: 2026

  // Metas numéricas
  meta_leads        Int?     // Quantidade de leads a captar
  meta_visitas      Int?     // Quantidade de visitas a realizar
  meta_propostas    Int?     // Quantidade de propostas a receber
  meta_fechamentos  Int?     // Quantidade de negócios a fechar
  meta_valor        Decimal? @db.Decimal(12, 2) // Valor total em vendas/alugueis

  // Progresso atual (atualizado automaticamente ou via job)
  progresso_leads       Int     @default(0)
  progresso_visitas     Int     @default(0)
  progresso_propostas   Int     @default(0)
  progresso_fechamentos Int     @default(0)
  progresso_valor       Decimal @default(0) @db.Decimal(12, 2)

  // Status da meta
  status StatusMeta @default(EM_ANDAMENTO)

  // Observações/notas
  observacoes String? @db.Text

  // Criado por (ADMIN/GESTOR)
  criado_por_id String?

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([tenant_id, corretor_id, mes, ano]) // Uma meta por corretor por mês
  @@index([tenant_id])
  @@index([corretor_id])
  @@index([mes, ano])
  @@index([status])
  @@map("metas")
}

enum StatusMeta {
  EM_ANDAMENTO  // Meta ainda em período válido
  ATINGIDA      // Meta atingida (100%+)
  NAO_ATINGIDA  // Período encerrado sem atingir
  CANCELADA     // Meta cancelada
}

// ============================================
// LOGS DE ATIVIDADES (AUDIT TRAIL)
// ============================================

model ActivityLog {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Usuário que executou a ação (pode ser null para ações automáticas)
  user_id String?
  user    User?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  // Tipo de atividade
  tipo TipoAtividade

  // Descrição da atividade
  acao        String // Ex: "Login realizado", "Senha alterada", "Tenant cancelado"
  detalhes    Json? // Informações adicionais (sem dados sensíveis)
  ip_address  String? // IP de onde a ação foi executada
  user_agent  String? // Navegador/dispositivo usado

  // Metadados
  entidade_tipo String? // Ex: "Tenant", "User", "Lead"
  entidade_id   String? // ID da entidade afetada

  // Timestamp
  created_at DateTime @default(now())

  @@index([tenant_id])
  @@index([user_id])
  @@index([tipo])
  @@index([created_at])
  @@index([entidade_tipo, entidade_id])
  @@map("activity_logs")
}

enum TipoAtividade {
  // Autenticação
  LOGIN
  LOGOUT
  LOGIN_FALHOU

  // Segurança
  SENHA_ALTERADA
  SENHA_RESETADA
  EMAIL_ALTERADO

  // Tenant
  TENANT_CRIADO
  TENANT_CANCELADO
  TENANT_REATIVADO
  TENANT_EXPORTACAO_DADOS

  // Assinatura
  ASSINATURA_ATIVADA
  ASSINATURA_CANCELADA
  PAGAMENTO_REALIZADO
  PAGAMENTO_FALHOU

  // Usuários
  USUARIO_CRIADO
  USUARIO_EDITADO
  USUARIO_DESATIVADO
  USUARIO_REATIVADO

  // Outros
  CONFIGURACAO_ALTERADA
  ACESSO_NEGADO
}

// ============================================
// CONFIGURAÇÃO WHATSAPP (TWILIO)
// ============================================

model WhatsAppConfig {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String @unique
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Credenciais Twilio
  twilio_account_sid  String?
  twilio_auth_token   String? // Criptografado
  twilio_phone_number String? // Número do WhatsApp Business (ex: +5511999999999)

  // Configurações de comportamento
  auto_response_enabled Boolean @default(true) // Respostas automáticas da Sofia
  welcome_message       String? @db.Text // Mensagem de boas-vindas personalizada
  business_hours_start  String? // Ex: "08:00"
  business_hours_end    String? // Ex: "18:00"
  out_of_hours_message  String? @db.Text // Mensagem fora do horário

  // Atribuição automática de leads
  auto_assign_corretor Boolean @default(false) // Atribuir corretor automaticamente
  default_corretor_id  String? // Corretor padrão para novos leads

  // Status
  is_active      Boolean @default(false) // Se a integração está ativa
  last_message_at DateTime? // Última mensagem recebida
  webhook_verified Boolean @default(false) // Se o webhook foi verificado

  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([tenant_id])
  @@map("whatsapp_configs")
}

// ============================================
// NOTIFICAÇÕES IN-APP
// ============================================

model Notification {
  id String @id @default(uuid())

  // Multi-tenant
  tenant_id String
  tenant    Tenant @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  // Destinatário
  user_id String
  user    User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Conteúdo
  title   String
  message String @db.Text
  type    NotificationType @default(INFO)

  // Referência opcional a uma entidade
  entity_type String? // Ex: "Lead", "Negociacao", "Agendamento"
  entity_id   String? // ID da entidade relacionada
  action_url  String? // URL para onde a notificação deve direcionar

  // Status
  is_read   Boolean @default(false)
  read_at   DateTime?

  // Timestamps
  created_at DateTime @default(now())

  @@index([tenant_id])
  @@index([user_id])
  @@index([is_read])
  @@index([created_at])
  @@map("notifications")
}

enum NotificationType {
  INFO       // Informação geral
  SUCCESS    // Ação bem-sucedida
  WARNING    // Alerta/aviso
  ERROR      // Erro
  LEAD       // Relacionado a lead
  NEGOCIACAO // Relacionado a negociação
  AGENDAMENTO // Relacionado a agendamento
  PROPOSTA   // Relacionado a proposta
  META       // Relacionado a metas
  SISTEMA    // Mensagem do sistema
}
